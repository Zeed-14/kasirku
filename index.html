<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Kasir Offline Modern</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <!-- Pustaka untuk Barcode Scanner & Generator -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <!-- Pustaka Dexie.js untuk IndexedDB -->
    <script src="https://unpkg.com/dexie@3/dist/dexie.js"></script>
    <style>
        :root {--background: #f0f2f5;--card-bg: #ffffff;--text-primary: #1f2937;--text-secondary: #6b7280;--primary-color: #4f46e5;--primary-hover: #4338ca;--border-color: #e5e7eb;}
        body {font-family: 'Inter', sans-serif;background-color: var(--background);color: var(--text-primary);}
        .scrollbar-thin::-webkit-scrollbar { width: 5px; } .scrollbar-thin::-webkit-scrollbar-track { background: #e5e7eb; } .scrollbar-thin::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 5px; }
        .tab-btn {position: relative;transition: color 0.3s ease;}
        .tab-btn.active {color: var(--primary-color);font-weight: 600;}
        .tab-btn.active::after {content: '';position: absolute;bottom: -1px;left: 0;right: 0;height: 3px;background-color: var(--primary-color);border-radius: 2px;}
        .card {background-color: var(--card-bg);border-radius: 12px;box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);}
        .btn-primary {background-color: var(--primary-color);color: white;transition: background-color 0.3s ease;}
        .btn-primary:hover {background-color: var(--primary-hover);}
        .modal-box {transition: all 0.3s ease-out;border-radius: 12px;}
        #scanner-container {z-index: 60;} #reader {border: 2px solid var(--primary-color); border-radius: 8px;}
        @media print {
            body.printing .no-print { display: none; }
            body.printing #printable-area { display: block; }
            body.printing > *:not(#printable-area) { display: none; }
            #printable-area { position: absolute; top: 0; left: 0; }
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 lg:p-6 no-print">
        <header class="mb-6 flex justify-between items-center"><h1 id="main-app-title" class="text-2xl md:text-3xl font-extrabold text-gray-800">Aplikasi Kasir Offline</h1><p id="auth-info" class="text-xs text-green-700 bg-green-100 px-3 py-1 rounded-full shadow-sm">Status: Online & Tersinkron</p></header>
        <div class="mb-6 border-b border-gray-200"><nav class="flex space-x-2 md:space-x-6"><button id="tab-kasir" class="tab-btn py-3 px-2 md:px-4 text-sm md:text-base font-medium text-gray-500 active"><i class="fas fa-cash-register mr-2 opacity-70"></i>Kasir</button><button id="tab-manajemen" class="tab-btn py-3 px-2 md:px-4 text-sm md:text-base font-medium text-gray-500"><i class="fas fa-box-open mr-2 opacity-70"></i>Produk</button><button id="tab-laporan" class="tab-btn py-3 px-2 md:px-4 text-sm md:text-base font-medium text-gray-500"><i class="fas fa-chart-line mr-2 opacity-70"></i>Laporan</button><button id="tab-pengaturan" class="tab-btn py-3 px-2 md:px-4 text-sm md:text-base font-medium text-gray-500"><i class="fas fa-cog mr-2 opacity-70"></i>Pengaturan</button></nav></div>
        <main>
            <!-- VIEW KASIR -->
            <div id="view-kasir"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 card p-4"><div class="flex flex-col md:flex-row gap-4 justify-between items-center mb-4 border-b pb-3"><h2 class="text-xl font-bold">Pilih Produk</h2><div class="flex w-full md:w-auto gap-2 items-center"><select id="category-filter" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300"><option value="all">Semua Kategori</option></select><div class="relative flex-grow"><input type="text" id="search-product-input" placeholder="Cari produk..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300 transition"><i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i></div><button id="scan-barcode-kasir-btn" class="p-2.5 h-full bg-gray-200 hover:bg-gray-300 rounded-lg" title="Pindai Barcode"><i class="fas fa-barcode text-gray-600"></i></button></div></div><div id="kasir-product-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div></div>
                <div class="lg:col-span-1"><div class="card p-4 sticky top-6"><h2 class="text-xl font-bold mb-4 border-b pb-3">Keranjang</h2><div id="cart-items" class="h-72 overflow-y-auto scrollbar-thin mb-4 pr-2"><p id="cart-placeholder" class="text-gray-400 text-center mt-12">Keranjang Anda kosong.</p></div><div class="space-y-3 border-t pt-4"><div class="flex justify-between items-center font-semibold"><span>Total</span><span id="total-price" class="text-2xl font-bold text-indigo-600">Rp 0</span></div><div class="flex justify-between items-center"><span>Bayar</span><input type="number" id="payment-amount" placeholder="Jumlah uang" class="w-36 text-right p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300"></div><div class="flex justify-between items-center font-semibold"><span>Kembali</span><span id="change-amount" class="text-xl text-green-600 font-bold">Rp 0</span></div></div><div class="mt-6 grid grid-cols-2 gap-3"><button id="reset-button" class="w-full bg-red-100 text-red-700 font-bold py-3 rounded-lg hover:bg-red-200 transition flex items-center justify-center gap-2"><i class="fas fa-sync-alt"></i> Reset</button><button id="process-payment-button" class="w-full btn-primary font-bold py-3 rounded-lg flex items-center justify-center gap-2"><i class="fas fa-cash-register"></i> Bayar</button></div></div></div>
            </div></div>
            <!-- VIEW MANAJEMEN PRODUK -->
            <div id="view-manajemen" class="hidden"><div class="card p-6 mb-6"><h2 class="text-xl font-bold text-orange-600 mb-4 flex items-center"><i class="fas fa-exclamation-triangle mr-3"></i>Perlu Perhatian: Stok Menipis</h2><div id="low-stock-table-container" class="overflow-x-auto"></div></div><div class="card p-6"><div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4"><h2 class="text-xl font-bold">Daftar Semua Produk</h2><div class="flex items-center gap-4"><select id="stock-filter" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300"><option value="all">Semua Stok</option><option value="safe">Stok Aman</option><option value="low">Stok Menipis</option><option value="out">Habis</option></select><button id="scan-to-add-btn" class="bg-indigo-100 text-indigo-700 font-bold px-4 py-2 rounded-lg hover:bg-indigo-200 flex items-center gap-2 transition"><i class="fas fa-barcode-read"></i> Pindai</button><button id="add-product-btn" class="bg-green-500 text-white font-bold px-4 py-2 rounded-lg hover:bg-green-600 flex items-center gap-2 transition"><i class="fas fa-plus"></i> Tambah</button></div></div><div id="all-products-table-container" class="overflow-x-auto"></div></div></div>
            <!-- VIEW LAPORAN -->
            <div id="view-laporan" class="hidden"><div class="card p-6"><h2 class="text-2xl font-bold mb-4">Laporan Penjualan</h2><div class="flex flex-wrap gap-4 items-center mb-6 p-4 bg-gray-50 rounded-lg"><select id="date-filter" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-300"><option value="today">Hari Ini</option><option value="last7days">7 Hari Terakhir</option><option value="thismonth">Bulan Ini</option><option value="custom">Kustom</option></select><div id="custom-date-range" class="flex gap-2 items-center hidden"><input type="date" id="start-date" class="p-2 border border-gray-300 rounded-lg"><span class="text-gray-500">hingga</span><input type="date" id="end-date" class="p-2 border border-gray-300 rounded-lg"><button id="apply-custom-date" class="px-4 py-2 btn-primary rounded-lg"><i class="fas fa-check"></i></button></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6"><div class="bg-indigo-50 p-6 rounded-lg"><p class="text-sm text-indigo-700 font-medium">Total Omzet</p><p id="report-omzet" class="text-3xl font-extrabold text-indigo-900">Rp 0</p></div><div class="bg-green-50 p-6 rounded-lg"><p class="text-sm text-green-700 font-medium">Total Transaksi</p><p id="report-transaksi" class="text-3xl font-extrabold text-green-900">0</p></div><div class="bg-purple-50 p-6 rounded-lg"><p class="text-sm text-purple-700 font-medium">Produk Terlaris</p><p id="report-terlaris" class="text-3xl font-extrabold text-purple-900 truncate">-</p></div></div><h3 class="text-xl font-bold mb-4">Rincian Transaksi</h3><div id="report-transactions-table" class="overflow-x-auto"></div></div></div>
            <!-- VIEW PENGATURAN -->
            <div id="view-pengaturan" class="hidden"><div class="card p-8 max-w-2xl mx-auto mb-6"><h2 class="text-2xl font-bold mb-6 border-b pb-4">Pengaturan Profil Toko</h2><form id="settings-form" class="space-y-6"><div><label for="store-name" class="block text-sm font-medium text-gray-700 mb-1">Nama Toko</label><input type="text" id="store-name" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"></div><div><label for="store-address" class="block text-sm font-medium text-gray-700 mb-1">Alamat Toko</label><textarea id="store-address" rows="3" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"></textarea></div><div><label for="store-phone" class="block text-sm font-medium text-gray-700 mb-1">Nomor Telepon</label><input type="tel" id="store-phone" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-400"></div><div class="flex justify-end pt-4"><button type="submit" class="px-8 py-3 btn-primary font-bold rounded-lg flex items-center gap-2"><i class="fas fa-save"></i> Simpan Pengaturan</button></div></form></div>
            <div class="card p-8 max-w-2xl mx-auto"><h2 class="text-2xl font-bold mb-6 border-b pb-4">Generator Barcode</h2><div class="space-y-4"><p class="text-sm text-gray-600">Buat barcode untuk produk internal atau cetak ulang barcode yang rusak.</p><div><label for="barcode-input" class="block text-sm font-medium text-gray-700 mb-1">Teks atau Angka untuk Barcode</label><div class="flex gap-2"><input type="text" id="barcode-input" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm"><button id="generate-barcode-btn" class="px-4 py-2 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-800">Generate</button></div></div><div id="barcode-output-container" class="text-center p-4 border-2 border-dashed rounded-lg hidden"><div id="barcode-output"></div><button id="print-barcode-btn" class="btn-primary font-semibold text-sm px-4 py-2 mt-4 rounded-lg flex items-center gap-2 mx-auto"><i class="fas fa-print"></i> Cetak Barcode Ini</button></div></div></div>
            </div>
        </main>
    </div>
    
    <!-- WRAPPER FOR PRINTABLE AREA -->
    <div id="printable-area" class="hidden"></div>

    <!-- ALL MODALS -->
    <div id="scanner-container" class="fixed inset-0 bg-black bg-opacity-70 flex-col items-center justify-center hidden z-50 modal-container no-print"><div class="w-full max-w-md p-4 bg-white rounded-lg shadow-xl"><h3 class="text-xl font-bold text-center mb-4">Arahkan Kamera ke Barcode</h3><div id="reader" class="w-full"></div><button id="close-scanner-btn" class="mt-4 w-full bg-red-500 text-white font-bold py-2 rounded-lg">Tutup Pemindai</button></div></div>
    <div id="product-form-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-40 modal-container no-print"><div class="bg-white p-8 modal-box w-full max-w-md"><h3 id="modal-title" class="text-2xl font-bold mb-6"></h3><form id="product-form"><input type="hidden" id="product-id"><div class="mb-4"><label for="product-name" class="block mb-2">Nama Produk</label><input type="text" id="product-name" class="w-full p-3 border rounded-lg" required></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label for="product-category" class="block mb-2">Kategori</label><input type="text" id="product-category" class="w-full p-3 border rounded-lg" placeholder="e.g. Minuman"></div><div><label for="product-barcode" class="block mb-2">Barcode</label><input type="text" id="product-barcode" class="w-full p-3 border rounded-lg"></div></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label for="product-price" class="block mb-2">Harga</label><input type="number" id="product-price" class="w-full p-3 border rounded-lg" required></div><div><label for="product-stock" class="block mb-2">Stok</label><input type="number" id="product-stock" class="w-full p-3 border rounded-lg" required></div></div><div class="mb-6"><label for="product-image" class="block mb-2">URL Gambar</label><input type="url" id="product-image" placeholder="https://..." class="w-full p-3 border rounded-lg"></div><div class="flex justify-end gap-4"><button type="button" id="cancel-btn" class="px-6 py-2 bg-gray-200 font-semibold rounded-lg">Batal</button><button type="submit" id="save-btn" class="px-6 py-2 btn-primary font-semibold rounded-lg flex items-center gap-2"><i class="fas fa-save"></i> Simpan</button></div></form></div></div>
    <div id="restock-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 modal-container no-print"><div class="bg-white p-8 modal-box w-full max-w-sm"><h3 class="text-2xl font-bold mb-6">Restok Produk</h3><form id="restock-form"><input type="hidden" id="restock-product-id"><div class="mb-4"><p>Produk: <span id="restock-product-name" class="font-bold"></span></p><p>Stok Saat Ini: <span id="restock-current-stock"></span></p></div><div class="mb-6"><label for="restock-quantity" class="block mb-2">Jumlah Stok Tambahan</label><input type="number" id="restock-quantity" class="w-full p-3 border rounded-lg" required min="1"></div><div class="flex justify-end gap-4"><button type="button" id="cancel-restock-btn" class="px-6 py-2 bg-gray-200 font-semibold rounded-lg">Batal</button><button type="submit" class="px-6 py-2 bg-green-500 text-white font-semibold rounded-lg">Tambah Stok</button></div></form></div></div>
    <div id="return-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 modal-container no-print"><div class="bg-white p-8 modal-box w-full max-w-sm"><h3 class="text-2xl font-bold mb-6">Retur ke Supplier</h3><form id="return-form"><input type="hidden" id="return-product-id"><div class="mb-4"><p>Produk: <span id="return-product-name" class="font-bold"></span></p><p>Stok Saat Ini: <span id="return-current-stock"></span></p></div><div class="mb-6"><label for="return-quantity" class="block mb-2">Jumlah yang Dikembalikan</label><input type="number" id="return-quantity" class="w-full p-3 border rounded-lg" required min="1"></div><div class="flex justify-end gap-4"><button type="button" id="cancel-return-btn" class="px-6 py-2 bg-gray-200 font-semibold rounded-lg">Batal</button><button type="submit" class="px-6 py-2 bg-orange-500 text-white font-semibold rounded-lg hover:bg-orange-600">Proses Retur</button></div></form></div></div>
    <div id="confirm-delete-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 modal-container no-print"><div class="bg-white p-8 modal-box text-center w-full max-w-sm"><div class="text-red-500 mb-4"><i class="fas fa-exclamation-triangle fa-4x"></i></div><h3 class="text-xl font-bold">Anda Yakin?</h3><p class="text-gray-600 mt-2 mb-6">Aksi ini akan menghapus data secara permanen.</p><div class="flex justify-center gap-4"><button id="cancel-delete-btn" class="px-6 py-2 bg-gray-200 font-semibold rounded-lg">Batal</button><button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white font-semibold rounded-lg">Ya, Hapus</button></div></div></div>
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 no-print"><div class="bg-white p-8 modal-box text-center"><div id="modal-icon"></div><h3 id="notification-title" class="text-2xl font-bold mt-4"></h3><p id="notification-message" class="text-gray-600 mt-2"></p><button id="modal-close-button" class="mt-6 btn-primary font-semibold px-6 py-2 rounded-lg">Tutup</button></div></div>
    <div id="struk-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50"><div class="bg-white p-6 rounded-lg w-full max-w-sm font-mono text-xs shadow-2xl"><div class="text-center mb-4"><h3 id="struk-store-name" class="text-base font-bold uppercase">Nama Toko Anda</h3><p id="struk-store-address">Alamat Toko Anda</p><p id="struk-store-phone">Telp: 08123456789</p><hr class="border-dashed my-2"></div><div id="struk-info" class="mb-2"></div><hr class="border-dashed my-2"><div id="struk-items" class="py-1"></div><hr class="border-dashed my-2"><div id="struk-total" class="space-y-1 pt-2"></div><hr class="border-dashed my-2"><div class="text-center mt-4"><p>Terima kasih telah berbelanja!</p></div><div class="mt-6 flex justify-end gap-3 no-print"><button id="struk-close-btn" class="px-4 py-2 bg-gray-200 font-semibold rounded-lg">Tutup</button><button id="struk-print-btn" class="px-4 py-2 btn-primary font-semibold rounded-lg flex items-center gap-2"><i class="fas fa-print"></i> Cetak</button></div></div></div>

    <script>
        // --- DATABASE SETUP (INDEXEDDB using DEXIE.JS) ---
        const db = new Dexie("KasirAppDBOffline");
        db.version(1).stores({
            products: '++id, &barcode, name, category', // id is auto-incrementing, barcode is unique
            transactions: '++id, createdAt', // id is auto-incrementing, index on createdAt
            settings: 'key' // Simple key-value store
        });

        // --- GLOBAL STATE & CONFIG ---
        let productsData=[], transactionsData=[], cart=[], storeSettings={name:"Aplikasi Kasir",address:"Alamat Toko",phone:"No. Telepon"}, currentProductIdToDelete=null, scannerMode=null;
        let html5QrCode;
        const LOW_STOCK_THRESHOLD=10;

        // --- DOM REFS ---
        const dom={mainTitle:document.getElementById("main-app-title"),kasirView:document.getElementById("view-kasir"),manajemenView:document.getElementById("view-manajemen"),laporanView:document.getElementById("view-laporan"),pengaturanView:document.getElementById("view-pengaturan"),kasirTab:document.getElementById("tab-kasir"),manajemenTab:document.getElementById("tab-manajemen"),laporanTab:document.getElementById("tab-laporan"),pengaturanTab:document.getElementById("tab-pengaturan"),kasirProductList:document.getElementById("kasir-product-list"),cartItems:document.getElementById("cart-items"),cartPlaceholder:document.getElementById("cart-placeholder"),totalPrice:document.getElementById("total-price"),paymentAmount:document.getElementById("payment-amount"),changeAmount:document.getElementById("change-amount"),resetButton:document.getElementById("reset-button"),paymentButton:document.getElementById("process-payment-button"),lowStockTable:document.getElementById("low-stock-table-container"),allProductsTable:document.getElementById("all-products-table-container"),addProductButton:document.getElementById("add-product-btn"),productModal:document.getElementById("product-form-modal"),productForm:document.getElementById("product-form"),productModalTitle:document.getElementById("modal-title"),productIdInput:document.getElementById("product-id"),productNameInput:document.getElementById("product-name"),productPriceInput:document.getElementById("product-price"),productImageInput:document.getElementById("product-image"),productStockInput:document.getElementById("product-stock"),productCategoryInput:document.getElementById("product-category"),productBarcodeInput:document.getElementById("product-barcode"),cancelButton:document.getElementById("cancel-btn"),saveButton:document.getElementById("save-btn"),deleteModal:document.getElementById("confirm-delete-modal"),cancelDeleteButton:document.getElementById("cancel-delete-btn"),confirmDeleteButton:document.getElementById("confirm-delete-btn"),notificationModal:document.getElementById("notification-modal"),notificationTitle:document.getElementById("notification-title"),notificationMessage:document.getElementById("notification-message"),notificationIcon:document.getElementById("modal-icon"),notificationCloseButton:document.getElementById("modal-close-button"),searchInput:document.getElementById("search-product-input"),strukModal:document.getElementById("struk-modal"),strukStoreName:document.getElementById("struk-store-name"),strukStoreAddress:document.getElementById("struk-store-address"),strukStorePhone:document.getElementById("struk-store-phone"),strukInfo:document.getElementById("struk-info"),strukItems:document.getElementById("struk-items"),strukTotal:document.getElementById("struk-total"),strukCloseButton:document.getElementById("struk-close-btn"),strukPrintButton:document.getElementById("struk-print-btn"),stockFilter:document.getElementById("stock-filter"),dateFilter:document.getElementById("date-filter"),customDateRange:document.getElementById("custom-date-range"),startDate:document.getElementById("start-date"),endDate:document.getElementById("end-date"),applyDateButton:document.getElementById("apply-custom-date"),reportOmzet:document.getElementById("report-omzet"),reportTransaksi:document.getElementById("report-transaksi"),reportTerlaris:document.getElementById("report-terlaris"),reportTable:document.getElementById("report-transactions-table"),restockModal:document.getElementById("restock-modal"),restockForm:document.getElementById("restock-form"),restockProductId:document.getElementById("restock-product-id"),restockProductName:document.getElementById("restock-product-name"),restockCurrentStock:document.getElementById("restock-current-stock"),restockQuantity:document.getElementById("restock-quantity"),cancelRestockButton:document.getElementById("cancel-restock-btn"),settingsForm:document.getElementById("settings-form"),storeNameInput:document.getElementById("store-name"),storeAddressInput:document.getElementById("store-address"),storePhoneInput:document.getElementById("store-phone"),returnModal:document.getElementById("return-modal"),returnForm:document.getElementById("return-form"),returnProductId:document.getElementById("return-product-id"),returnProductName:document.getElementById("return-product-name"),returnCurrentStock:document.getElementById("return-current-stock"),returnQuantity:document.getElementById("return-quantity"),cancelReturnButton:document.getElementById("cancel-return-btn"),categoryFilter:document.getElementById("category-filter"),scanBarcodeKasirBtn:document.getElementById("scan-barcode-kasir-btn"),scannerContainer:document.getElementById("scanner-container"),closeScannerBtn:document.getElementById("close-scanner-btn"),scanToAddBtn:document.getElementById("scan-to-add-btn"),barcodeInput:document.getElementById("barcode-input"),generateBarcodeBtn:document.getElementById("generate-barcode-btn"),barcodeOutputContainer:document.getElementById("barcode-output-container"),barcodeOutput:document.getElementById("barcode-output"),printBarcodeBtn:document.getElementById("print-barcode-btn"),printableArea:document.getElementById("printable-area")};

        // --- UTILS & HELPERS ---
        const formatRupiah=(n)=>new Intl.NumberFormat("id-ID",{style:"currency",currency:"IDR",minimumFractionDigits:0}).format(n);const formatDate=(d)=>new Date(d).toLocaleString("id-ID",{dateStyle:"short",timeStyle:"short"});
        const showNotif=(t,h,m)=>{const i={success:'<i class="fas fa-check-circle text-5xl text-green-500"></i>',error:'<i class="fas fa-times-circle text-5xl text-red-500"></i>',warning:'<i class="fas fa-exclamation-triangle text-5xl text-yellow-500"></i>'};dom.notificationIcon.innerHTML=i[t]||"";dom.notificationTitle.textContent=h;dom.notificationMessage.textContent=m;dom.notificationModal.classList.remove("hidden")};const hideNotif=()=>dom.notificationModal.classList.add("hidden");
        const updateSettingsUI=(settings)=>{dom.mainTitle.textContent=settings.name;dom.strukStoreName.textContent=settings.name;dom.strukStoreAddress.textContent=settings.address;dom.strukStorePhone.textContent=settings.phone;dom.storeNameInput.value=settings.name;dom.storeAddressInput.value=settings.address;dom.storePhoneInput.value=settings.phone};
        const switchView=(v)=>{const views=["kasir","manajemen","laporan","pengaturan"];views.forEach(view=>{dom[`${view}View`].classList.toggle("hidden",v!==view);dom[`${view}Tab`].classList.toggle("active",v===view)});if(v==='laporan')renderReports()};
        const populateCategoryFilter=()=>{const categories=[...new Set(productsData.map(p=>p.category).filter(Boolean))];dom.categoryFilter.innerHTML='<option value="all">Semua Kategori</option>';categories.sort().forEach(c=>{const option=document.createElement("option");option.value=c;option.textContent=c;dom.categoryFilter.appendChild(option)})};

        // --- RENDER FUNCTIONS ---
        const applyKasirFilters=()=>{const searchTerm=dom.searchInput.value.toLowerCase();const selectedCategory=dom.categoryFilter.value;let filtered=productsData;if(selectedCategory!=='all'){filtered=filtered.filter(p=>p.category===selectedCategory)}if(searchTerm){filtered=filtered.filter(p=>p.name.toLowerCase().includes(searchTerm))}renderProductGridForKasir(filtered)};
        const renderProductGridForKasir=(prods)=>{dom.kasirProductList.innerHTML="";if(prods.length===0){dom.kasirProductList.innerHTML=`<p class="col-span-full text-center text-gray-500 py-10">Produk tidak ditemukan.</p>`;return}prods.forEach(p=>{const out=p.stock<=0;const c=document.createElement("div");c.className=`card relative border border-transparent p-2 text-center cursor-pointer hover:shadow-xl hover:border-indigo-500 transition-all duration-300 group ${out?"opacity-50 pointer-events-none":""}`;c.innerHTML=`${out?'<span class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded-full font-semibold">Habis</span>':''}<div class="overflow-hidden rounded-lg"><img src="${p.image||"https://placehold.co/200x200/e0e7ff/4338ca?text=N/A"}" alt="${p.name}" class="w-full h-28 object-cover group-hover:scale-110 transition-transform duration-300"></div><h3 class="font-bold text-sm mt-3 mb-1 truncate">${p.name}</h3><p class="text-indigo-600 text-xs font-semibold">${formatRupiah(p.price)}</p>`;if(!out)c.onclick=()=>addToCart(p.id);dom.kasirProductList.appendChild(c)})};
        const createProductTable=(prods,container)=>{container.innerHTML="";if(prods.length===0){container.innerHTML=`<p class="text-center py-6 text-gray-500">Tidak ada produk.</p>`;return}const table=document.createElement("table");table.className="min-w-full bg-white text-sm";table.innerHTML=`<thead class="bg-gray-50"><tr><th class="py-3 px-4 text-left font-semibold text-gray-600">Produk</th><th class="py-3 px-4 text-left font-semibold text-gray-600">Barcode</th><th class="py-3 px-4 text-left font-semibold text-gray-600">Kategori</th><th class="py-3 px-4 text-left font-semibold text-gray-600">Stok</th><th class="py-3 px-4 text-center font-semibold text-gray-600">Aksi</th></tr></thead>`;const tbody=document.createElement("tbody");prods.forEach(p=>{const tr=document.createElement("tr");tr.className=`border-b border-gray-200 hover:bg-gray-50 ${p.stock<=0?"bg-red-50":""}`;tr.innerHTML=`<td class="py-3 px-4 flex items-center gap-3"><img src="${p.image||"https://placehold.co/100x100?text=N/A"}" class="h-10 w-10 object-cover rounded-md"><span class="font-bold">${p.name}</span></td><td class="py-3 px-4 font-mono text-gray-500">${p.barcode||'-'}</td><td class="py-3 px-4"><span class="bg-gray-200 text-gray-700 text-xs font-medium px-2.5 py-1 rounded-full">${p.category||'N/A'}</span></td><td class="py-3 px-4 font-bold text-lg ${p.stock<=LOW_STOCK_THRESHOLD?"text-red-500":""}">${p.stock}</td><td class="py-3 px-4 text-center whitespace-nowrap"><button data-id="${p.id}" class="restock-btn text-green-500 p-2 hover:bg-green-100 rounded-full" title="Restok"><i class="fas fa-plus-circle fa-fw"></i></button><button data-id="${p.id}" class="return-btn text-orange-500 p-2 hover:bg-orange-100 rounded-full" title="Retur"><i class="fas fa-undo fa-fw"></i></button><button data-id="${p.id}" class="edit-btn text-blue-500 p-2 hover:bg-blue-100 rounded-full" title="Ubah"><i class="fas fa-edit fa-fw"></i></button><button data-id="${p.id}" class="delete-btn text-red-500 p-2 hover:bg-red-100 rounded-full" title="Hapus"><i class="fas fa-trash-alt fa-fw"></i></button></td>`;tbody.appendChild(tr)});table.appendChild(tbody);container.appendChild(table)};
        const renderMgmtPage=()=>{const filter=dom.stockFilter.value;let filteredProds=productsData;if(filter==="safe")filteredProds=productsData.filter(p=>p.stock>LOW_STOCK_THRESHOLD);if(filter==="low")filteredProds=productsData.filter(p=>p.stock<=LOW_STOCK_THRESHOLD&&p.stock>0);if(filter==="out")filteredProds=productsData.filter(p=>p.stock<=0);createProductTable(filteredProds,dom.allProductsTable);const lowStockProds=productsData.filter(p=>p.stock<=LOW_STOCK_THRESHOLD);createProductTable(lowStockProds,dom.lowStockTable)};
        const renderCart=()=>{if(cart.length===0){dom.cartItems.innerHTML="";dom.cartPlaceholder.classList.remove("hidden")}else{dom.cartPlaceholder.classList.add("hidden");dom.cartItems.innerHTML="";cart.forEach(i=>{const e=document.createElement("div");e.className="flex justify-between items-center py-3 border-b";e.innerHTML=`<div class="flex-grow"><p class="font-bold truncate">${i.name}</p><p class="text-xs text-gray-500">${i.quantity} x ${formatRupiah(i.price)}</p></div><div class="font-semibold mx-3">${formatRupiah(i.price*i.quantity)}</div><button class="text-red-500 hover:text-red-700" onclick="app.removeFromCart(${i.id})"><i class="fas fa-times-circle"></i></button>`;dom.cartItems.appendChild(e)})}updateTotal()};const updateTotal=()=>{const t=cart.reduce((s,i)=>s+(i.price*i.quantity),0);dom.totalPrice.textContent=formatRupiah(t);calculateChange()};const calculateChange=()=>{const t=cart.reduce((s,i)=>s+(i.price*i.quantity),0);const p=parseFloat(dom.paymentAmount.value)||0;const c=p-t;dom.changeAmount.textContent=(p>0&&c>=0)?formatRupiah(c):"Rp 0"};
        const renderReports=()=>{let start,end=new Date();end.setHours(23,59,59,999);switch(dom.dateFilter.value){case"today":start=new Date();start.setHours(0,0,0,0);break;case"last7days":start=new Date();start.setDate(start.getDate()-6);start.setHours(0,0,0,0);break;case"thismonth":start=new Date(end.getFullYear(),end.getMonth(),1);break;case"custom":start=new Date(dom.startDate.value);end=new Date(dom.endDate.value);end.setHours(23,59,59,999);break;}const filteredTrans=transactionsData.filter(t=>t.createdAt>=start&&t.createdAt<=end);let totalOmzet=0,totalTransaksi=filteredTrans.length,salesCount={};filteredTrans.forEach(t=>{totalOmzet+=t.totalAmount;t.items.forEach(i=>{salesCount[i.name]=(salesCount[i.name]||0)+i.quantity})});const bestSeller=Object.keys(salesCount).length>0?Object.entries(salesCount).sort((a,b)=>b[1]-a[1])[0][0]:"-";dom.reportOmzet.textContent=formatRupiah(totalOmzet);dom.reportTransaksi.textContent=totalTransaksi;dom.reportTerlaris.textContent=bestSeller;dom.reportTable.innerHTML="";if(filteredTrans.length===0){dom.reportTable.innerHTML='<p class="text-center py-6 text-gray-500">Tidak ada transaksi.</p>';return}const table=document.createElement("table");table.className="min-w-full bg-white text-sm";table.innerHTML=`<thead class="bg-gray-50"><tr><th class="p-3 text-left font-semibold text-gray-600">Tanggal</th><th class="p-3 text-left font-semibold text-gray-600">Item</th><th class="p-3 text-right font-semibold text-gray-600">Total</th></tr></thead>`;const tbody=document.createElement("tbody");filteredTrans.sort((a,b)=>b.createdAt-a.createdAt).forEach(t=>{const tr=document.createElement("tr");tr.className="border-b border-gray-200";tr.innerHTML=`<td class="p-3 align-top">${formatDate(t.createdAt)}</td><td class="p-3">${t.items.map(i=>`${i.quantity}x ${i.name}`).join("<br>")}</td><td class="p-3 text-right align-top font-bold">${formatRupiah(t.totalAmount)}</td>`;tbody.appendChild(tr)});table.appendChild(tbody);dom.reportTable.appendChild(table)};

        // --- CORE LOGIC (KASIR, MANAJEMEN, ETC) ---
        const addToCart=(id)=>{const p=productsData.find(prod=>prod.id===id);if(!p)return;const cartItem=cart.find(i=>i.id===id);const qtyInCart=cartItem?cartItem.quantity:0;if(qtyInCart+1>p.stock){showNotif("error","Stok Tidak Cukup",`Stok ${p.name} hanya tersisa ${p.stock}.`);return}if(cartItem)cartItem.quantity++;else cart.push({...p,quantity:1});renderCart()};const removeFromCart=(id)=>{const idx=cart.findIndex(i=>i.id===id);if(idx>-1){if(cart[idx].quantity>1)cart[idx].quantity--;else cart.splice(idx,1)}renderCart()};const resetTransaction=()=>{cart=[];dom.paymentAmount.value="";renderCart()};
        const processPayment=async()=>{if(cart.length===0)return showNotif("warning","Keranjang Kosong","Tidak ada produk.");const total=cart.reduce((s,i)=>s+(i.price*i.quantity),0),payment=parseFloat(dom.paymentAmount.value)||0;if(payment<total)return showNotif("error","Pembayaran Kurang","Uang tidak cukup.");dom.paymentButton.disabled=true;dom.paymentButton.innerHTML=`<i class="fas fa-spinner fa-spin"></i>`;try{const transactionId=await db.transaction('rw',db.products,db.transactions,async()=>{const transId=await db.transactions.add({items:cart,totalAmount:total,paymentAmount:payment,changeAmount:payment-total,createdAt:new Date()});for(const item of cart){await db.products.where('id').equals(item.id).modify({$inc:{stock:-item.quantity}})};return transId});const savedTransaction=await db.transactions.get(transactionId);showReceipt({...savedTransaction,id:transactionId});resetTransaction()}catch(e){console.error(e);showNotif("error","Transaksi Gagal",e.message)}finally{dom.paymentButton.disabled=false;dom.paymentButton.innerHTML=`<i class="fas fa-cash-register"></i> Bayar`}};
        const handleFormSubmit=async e=>{e.preventDefault();const id=parseInt(dom.productIdInput.value);const data={name:dom.productNameInput.value,price:parseFloat(dom.productPriceInput.value),stock:parseInt(dom.productStockInput.value),category:dom.productCategoryInput.value.trim()||null,barcode:dom.productBarcodeInput.value.trim()||null,image:dom.productImageInput.value.trim()||`https://placehold.co/200x200?text=${encodeURIComponent(dom.productNameInput.value)}`,lastUpdatedAt:new Date()};try{if(id){await db.products.update(id,data)}else{data.createdAt=new Date();await db.products.add(data)}hideProductModal();await refreshAllData()}catch(err){console.error(err);showNotif("error","Gagal Menyimpan",err.message)}};
        const handleDelete=async()=>{if(!currentProductIdToDelete)return;try{await db.products.delete(currentProductIdToDelete);hideDeleteConfirm();await refreshAllData()}catch(err){console.error(err)}};
        const handleRestockSubmit=async e=>{e.preventDefault();const id=parseInt(dom.restockProductId.value),qty=parseInt(dom.restockQuantity.value);if(!id||!qty||qty<=0)return;try{await db.products.where('id').equals(id).modify({$inc:{stock:qty}});hideRestockModal();dom.restockForm.reset();showNotif("success","Berhasil",`${qty} item ditambahkan.`);await refreshAllData()}catch(err){console.error(err);showNotif("error","Gagal Restok",err.message)}};
        const handleReturnSubmit=async e=>{e.preventDefault();const id=parseInt(dom.returnProductId.value),qty=parseInt(dom.returnQuantity.value);if(!id||!qty||qty<=0)return;try{const product=await db.products.get(id);if(qty>product.stock){showNotif("error","Gagal Retur","Jumlah retur melebihi stok.");return}await db.products.where('id').equals(id).modify({$inc:{stock:-qty}});hideReturnModal();dom.returnForm.reset();showNotif("success","Berhasil",`${qty} item diretur.`);await refreshAllData()}catch(err){console.error(err);showNotif("error","Gagal Retur",err.message)}};
        const handleSettingsSave=async e=>{e.preventDefault();const settingsData={name:dom.storeNameInput.value||"Nama Toko",address:dom.storeAddressInput.value||"Alamat Toko",phone:dom.storePhoneInput.value||"No. Telepon"};try{await db.settings.put({key:'storeProfile',value:settingsData});storeSettings=settingsData;updateSettingsUI(storeSettings);showNotif("success","Berhasil","Pengaturan toko disimpan.")}catch(err){console.error(err);showNotif("error","Gagal","Tidak dapat menyimpan pengaturan.")}};
        function showReceipt(data){dom.strukInfo.innerHTML=`<div>No. Struk: ${data.id}</div><div>Tgl: ${formatDate(data.createdAt)}</div>`;dom.strukItems.innerHTML=data.items.map(i=>`<div class="flex justify-between"><span>${i.quantity} ${i.name}</span><span>${formatRupiah(i.price*i.quantity)}</span></div>`).join("");dom.strukTotal.innerHTML=`<div class="flex justify-between font-bold"><span>TOTAL</span><span>${formatRupiah(data.totalAmount)}</span></div><div class="flex justify-between"><span>BAYAR</span><span>${formatRupiah(data.paymentAmount)}</span></div><div class="flex justify-between"><span>KEMBALI</span><span>${formatRupiah(data.changeAmount)}</span></div>`;dom.strukModal.classList.remove("hidden")}function hideReceipt(){dom.strukModal.classList.add("hidden")}
        const showProductModal=(edit=false,p={})=>{dom.productForm.reset();dom.productModalTitle.textContent=edit?"Ubah Produk":"Tambah Produk";dom.productIdInput.value=edit?p.id:"";dom.productNameInput.value=edit?p.name:"";dom.productPriceInput.value=edit?p.price:"";dom.productStockInput.value=edit?p.stock:"";dom.productCategoryInput.value=edit?p.category||"":"";dom.productBarcodeInput.value=edit?p.barcode||"":"";dom.productImageInput.value=edit?p.image||"":"";dom.productModal.classList.remove("hidden")};const hideProductModal=()=>dom.productModal.classList.add("hidden");const showDeleteConfirm=(id)=>{currentProductIdToDelete=id;dom.deleteModal.classList.remove("hidden")};const hideDeleteConfirm=()=>dom.deleteModal.classList.add("hidden");const showRestockModal=(id)=>{const p=productsData.find(prod=>prod.id===id);if(!p)return;dom.restockProductId.value=id;dom.restockProductName.textContent=p.name;dom.restockCurrentStock.textContent=p.stock;dom.restockModal.classList.remove("hidden")};const hideRestockModal=()=>dom.restockModal.classList.add("hidden");
        const showReturnModal=(id)=>{const p=productsData.find(prod=>prod.id===id);if(!p)return;dom.returnProductId.value=id;dom.returnProductName.textContent=p.name;dom.returnCurrentStock.textContent=p.stock;dom.returnModal.classList.remove("hidden")};const hideReturnModal=()=>dom.returnModal.classList.add("hidden");
        
        // --- BARCODE SCANNER (BUGFIXED) ---
        const stopScanner=async()=>{if(html5QrCode&&html5QrCode.isScanning){try{await html5QrCode.stop();console.log("Scanner stopped.")}catch(err){console.error("Failed to stop scanner.",err)}}dom.scannerContainer.classList.add("hidden");dom.scannerContainer.classList.remove("flex")};
        const startScanner=(mode)=>{scannerMode=mode;dom.scannerContainer.classList.remove("hidden");dom.scannerContainer.classList.add("flex");const onScanSuccess=async(decodedText,decodedResult)=>{await stopScanner();if(scannerMode==='addToCart'){const product=await db.products.where('barcode').equals(decodedText).first();if(product){addToCart(product.id);showNotif("success","Produk Ditemukan",`${product.name} ditambahkan.`)}else{showNotif("error","Tidak Ditemukan","Produk dengan barcode ini tidak ada.")}}else if(scannerMode==='addNewProduct'){const existing=await db.products.where('barcode').equals(decodedText).first();if(existing){showNotif("warning","Barcode Terdaftar",`Barcode ini untuk produk: ${existing.name}`)}else{showProductModal();dom.productBarcodeInput.value=decodedText}}};const config={fps:10,qrbox:{width:250,height:250}};html5QrCode.start({facingMode:"environment"},config,onScanSuccess,(error)=>{}).catch(err=>{console.error("Failed to start scanner",err);showNotif("error","Gagal","Tidak dapat akses kamera.");stopScanner()})};
        
        // --- BARCODE GENERATOR (BUGFIXED) ---
        const generateBarcode=()=>{const text=dom.barcodeInput.value;if(!text){showNotif("warning","Input Kosong","Masukkan teks untuk membuat barcode.");return}dom.barcodeOutputContainer.classList.remove("hidden");dom.barcodeOutput.innerHTML=`<svg id="barcode-display"></svg>`;try{JsBarcode("#barcode-display",text,{format:"CODE128",lineColor:"#000",width:2,height:100,displayValue:true})}catch(e){showNotif("error","Gagal Membuat Barcode",e.message);dom.barcodeOutputContainer.classList.add("hidden")}};
        const printBarcode=()=>{if(dom.barcodeOutput.innerHTML===""){showNotif("warning","Generate Dahulu","Buat barcode sebelum mencetak.");return}const barcodeContainer=document.getElementById("barcode-output");dom.printableArea.innerHTML=barcodeContainer.innerHTML;document.body.classList.add("printing");window.print();document.body.classList.remove("printing")};
        
        // --- INIT & DATA SYNC ---
        const refreshUI=()=>{applyKasirFilters();renderMgmtPage();renderReports();populateCategoryFilter();updateSettingsUI(storeSettings)};
        const refreshAllData=async()=>{const [products,transactions,settings]=await Promise.all([db.products.toArray(),db.transactions.toArray(),db.settings.get('storeProfile')]);productsData=products;transactionsData=transactions;if(settings)storeSettings=settings.value;refreshUI()};
        
        window.app={addToCart,removeFromCart};
        document.addEventListener('DOMContentLoaded',async()=>{html5QrCode=new Html5Qrcode("reader");await refreshAllData()});

        // --- ALL EVENT LISTENERS ---
        dom.kasirTab.addEventListener("click",()=>switchView("kasir"));dom.manajemenTab.addEventListener("click",()=>switchView("manajemen"));dom.laporanTab.addEventListener("click",()=>switchView("laporan"));dom.pengaturanTab.addEventListener("click",()=>switchView("pengaturan"));
        dom.searchInput.addEventListener("input",applyKasirFilters);dom.categoryFilter.addEventListener("change",applyKasirFilters);
        dom.scanBarcodeKasirBtn.addEventListener("click",()=>startScanner('addToCart'));dom.scanToAddBtn.addEventListener("click",()=>startScanner('addNewProduct'));dom.closeScannerBtn.addEventListener("click",stopScanner);
        dom.generateBarcodeBtn.addEventListener("click",generateBarcode);dom.printBarcodeBtn.addEventListener("click",printBarcode);
        dom.paymentAmount.addEventListener("input",calculateChange);dom.resetButton.addEventListener("click",resetTransaction);dom.paymentButton.addEventListener("click",processPayment);
        dom.manajemenView.addEventListener("click",async e=>{const edit=e.target.closest(".edit-btn"),del=e.target.closest(".delete-btn"),restock=e.target.closest(".restock-btn"),retur=e.target.closest(".return-btn");if(edit){const product=await db.products.get(parseInt(edit.dataset.id));if(product)showProductModal(true,product)}if(del)showDeleteConfirm(parseInt(del.dataset.id));if(restock)showRestockModal(parseInt(restock.dataset.id));if(retur)showReturnModal(parseInt(retur.dataset.id))});
        dom.addProductButton.addEventListener("click",()=>showProductModal(false));dom.cancelButton.addEventListener("click",hideProductModal);dom.productForm.addEventListener("submit",handleFormSubmit);
        dom.cancelDeleteButton.addEventListener("click",hideDeleteConfirm);dom.confirmDeleteButton.addEventListener("click",handleDelete);
        dom.notificationCloseButton.addEventListener("click",hideNotif);
        dom.strukCloseButton.addEventListener("click",hideReceipt);dom.strukPrintButton.addEventListener("click",()=>{dom.strukModal.classList.add('printing');window.print();dom.strukModal.classList.remove('printing')});
        dom.stockFilter.addEventListener("change",renderMgmtPage);
        dom.dateFilter.addEventListener("change",e=>{dom.customDateRange.classList.toggle("hidden",e.target.value!=="custom");if(e.target.value!=="custom")renderReports()});
        dom.applyDateButton.addEventListener("click",renderReports);
        dom.cancelRestockButton.addEventListener("click",hideRestockModal);dom.restockForm.addEventListener("submit",handleRestockSubmit);
        dom.cancelReturnButton.addEventListener("click",hideReturnModal);dom.returnForm.addEventListener("submit",handleReturnSubmit);
        dom.settingsForm.addEventListener("submit",handleSettingsSave);
    </script>
</body>
</html>

