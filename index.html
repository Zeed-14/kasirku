<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi POS Modern</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1f2937"/>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1f2937/ffffff?text=POS">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icons (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Supabase & LocalForage Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>

    <!-- Barcode, Chart & PDF Libraries -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-inter { font-family: 'Inter', sans-serif; }
        .font-poppins { font-family: 'Poppins', sans-serif; }
        .font-lato { font-family: 'Lato', sans-serif; }
        
        .debug-console {
            position: fixed; bottom: 10px; right: 10px; width: 350px; height: 200px;
            background-color: rgba(0, 0, 0, 0.85); color: #0f0; font-family: monospace;
            font-size: 12px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex; flex-direction: column; z-index: 9999; transform: translate3d(0, 0, 0);
        }
        .debug-console-header {
            padding: 8px 10px; background-color: rgba(255, 255, 255, 0.1); cursor: move;
            display: flex; justify-content: space-between; align-items: center;
        }
        .debug-console-content { flex-grow: 1; overflow-y: auto; padding: 10px; }
        .debug-console-content p { margin: 0; padding: 2px 0; }

        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 10000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast {
            display: flex; align-items: center; padding: 12px 16px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); color: white; opacity: 0;
            transform: translateX(100%); transition: all 0.4s ease-in-out;
        }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast-success { background-color: #10b981; }
        .toast-error { background-color: #ef4444; }
        .toast-info { background-color: #3b82f6; }

        .low-stock-row { background-color: #fef9c3; }
        .dark .low-stock-row { background-color: #4a4122; }
        
        .sortable-header { cursor: pointer; user-select: none; }
        .sortable-header:hover { background-color: #f3f4f6; }
        .dark .sortable-header:hover { background-color: #374151; }

        @media print { 
            .no-print { display: none !important; } 
            #app-container { display: none; }
            #printable-report { display: block !important; }
        }
        [x-cloak] { display: none !important; }
        
        #barcode-reader { width: 90%; max-width: 500px; background: white; border-radius: 10px; overflow: hidden; }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div id="app-container">
        <div id="app" class="flex flex-col h-screen">
            <nav class="w-full bg-white dark:bg-gray-800 shadow-md flex justify-between items-center p-4 no-print">
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-3">
                        <img id="store-logo-sidebar" src="https://placehold.co/40x40/4f46e5/ffffff?text=P" class="h-10 w-10 rounded-full object-cover">
                        <h1 id="store-name-sidebar" class="text-xl font-bold hidden sm:block">POS App</h1>
                    </div>
                    <ul class="flex items-center gap-2">
                        <li class="nav-item" data-page="kasir"><a href="#" class="flex items-center py-2 px-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="shopping-cart" class="w-5 h-5"></i><span class="ml-2 hidden md:inline">Kasir</span></a></li>
                        <li class="nav-item" data-page="produk"><a href="#" class="flex items-center py-2 px-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="package" class="w-5 h-5"></i><span class="ml-2 hidden md:inline">Produk</span></a></li>
                        <li class="nav-item" data-page="stok"><a href="#" class="flex items-center py-2 px-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="archive" class="w-5 h-5"></i><span class="ml-2 hidden md:inline">Stok</span></a></li>
                        <li class="nav-item" data-page="laporan"><a href="#" class="flex items-center py-2 px-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="bar-chart-2" class="w-5 h-5"></i><span class="ml-2 hidden md:inline">Laporan</span></a></li>
                        <li class="nav-item" data-page="pengaturan"><a href="#" class="flex items-center py-2 px-3 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700"><i data-lucide="settings" class="w-5 h-5"></i><span class="ml-2 hidden md:inline">Pengaturan</span></a></li>
                    </ul>
                </div>
                
                <div class="flex items-center space-x-4">
                    <div id="online-status" class="flex items-center"><span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span><span class="ml-2 hidden lg:inline">Offline</span></div>
                    <button id="install-pwa-btn" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 hidden sm:flex items-center"><i data-lucide="download-cloud" class="w-5 h-5"></i><span class="ml-2 hidden lg:inline">Install</span></button>
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700"><i data-lucide="sun" class="w-6 h-6 block dark:hidden"></i><i data-lucide="moon" class="w-6 h-6 hidden dark:block"></i></button>
                </div>
            </nav>

            <main class="flex-1 flex overflow-hidden">
                <div id="page-content" class="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto"></div>
            </main>
        </div>
        
        <div id="toast-container"></div>
        <div id="debug-console" class="debug-console">
            <div id="debug-console-header" class="debug-console-header">
                <span class="text-white font-bold">Konsol Debug</span>
                <button id="clear-debug-btn" class="text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="debug-content" class="debug-console-content"></div>
        </div>
        <div id="modal-container"></div>
        <div id="barcode-scanner-overlay" class="fixed inset-0 bg-black bg-opacity-75 z-[10000] hidden items-center justify-center flex-col">
            <div id="barcode-reader" class="w-11/12 max-w-lg"></div>
            <button id="stop-camera-scan-btn" class="mt-4 py-2 px-6 bg-red-600 text-white rounded-lg font-semibold">Tutup Kamera</button>
        </div>
    </div>

    <!-- TEMPLATES -->
    <template id="kasir-page-template">
        <div class="flex flex-col lg:flex-row gap-6 h-full">
            <div class="w-full lg:w-3/5 flex flex-col">
                <div class="mb-4">
                    <div class="flex border-b border-gray-200 dark:border-gray-700">
                        <button class="tab-btn active py-2 px-4 font-semibold" data-tab="toko">Produk Toko</button>
                        <button class="tab-btn py-2 px-4 font-semibold text-gray-500" data-tab="ppob">Produk Digital (PPOB)</button>
                    </div>
                </div>
                <div id="kasir-content"></div>
            </div>
            <div class="w-full lg:w-2/5 bg-white dark:bg-gray-800 rounded-xl shadow-lg flex flex-col p-4">
                <div class="flex justify-between items-center border-b pb-2 mb-2 border-gray-200 dark:border-gray-700">
                    <h3 class="text-xl font-bold">Keranjang</h3>
                    <button id="clear-cart-btn" class="text-red-500 hover:text-red-700 disabled:opacity-50" disabled>
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="cart-items" class="flex-grow overflow-y-auto">
                   <div class="text-center py-10 text-gray-500"><i data-lucide="shopping-basket" class="w-16 h-16 mx-auto mb-2"></i><p>Keranjang masih kosong</p></div>
                </div>
                <div class="border-t pt-4 border-gray-200 dark:border-gray-700">
                    <div class="flex justify-between mb-2"><span>Subtotal</span><span id="cart-subtotal">Rp 0</span></div>
                    <div class="flex justify-between mb-2">
                        <span>Diskon</span>
                        <span id="cart-discount" class="text-red-500">- Rp 0</span>
                    </div>
                    <div class="flex justify-between font-bold text-lg mb-4"><span>Total</span><span id="cart-total">Rp 0</span></div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button id="hold-cart-btn" class="w-full flex items-center justify-center gap-2 bg-yellow-500 text-white p-3 rounded-lg font-bold hover:bg-yellow-600 disabled:bg-gray-400" disabled><i data-lucide="pause-circle" class="w-5 h-5"></i>Tahan</button>
                        <button id="resume-cart-btn" class="w-full flex items-center justify-center gap-2 bg-cyan-500 text-white p-3 rounded-lg font-bold hover:bg-cyan-600 relative">
                            <i data-lucide="play-circle" class="w-5 h-5"></i>Lanjutkan
                            <span id="held-cart-badge" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
                        </button>
                    </div>
                    <div class="flex gap-2">
                         <button id="discount-btn" class="w-1/3 bg-amber-500 text-white p-3 rounded-lg font-bold hover:bg-amber-600 disabled:bg-gray-400" disabled>Diskon</button>
                         <button id="pay-btn" class="w-2/3 bg-indigo-600 text-white p-3 rounded-lg font-bold text-lg hover:bg-indigo-700 disabled:bg-gray-400" disabled>Bayar</button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="produk-toko-template">
        <div class="flex-grow flex flex-col">
            <div class="flex flex-wrap gap-4 mb-4">
                <div class="flex-grow relative">
                    <input type="text" id="product-search" placeholder="Cari produk atau scan barcode..." class="w-full p-3 rounded-lg bg-gray-200 dark:bg-gray-700 border border-transparent focus:border-indigo-500 focus:ring-indigo-500 pl-4 pr-12">
                    <button id="start-camera-scan-btn" class="absolute inset-y-0 right-0 flex items-center px-4 text-gray-600 hover:text-indigo-600">
                        <i data-lucide="camera" class="w-6 h-6"></i>
                    </button>
                </div>
                <div class="flex-grow md:flex-grow-0">
                    <select id="kasir-category-filter" class="w-full h-full p-3 rounded-lg bg-gray-200 dark:bg-gray-700">
                        <option value="all">Semua Kategori</option>
                    </select>
                </div>
                <button id="custom-sale-btn" class="bg-purple-600 text-white p-3 rounded-lg flex items-center gap-2 hover:bg-purple-700">
                    <i data-lucide="plus-square" class="w-5 h-5"></i>
                    <span class="hidden sm:inline">Item Kustom</span>
                </button>
            </div>
            <div id="product-list" class="flex-grow overflow-y-auto grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4"></div>
        </div>
    </template>
    
    <template id="ppob-template">
        <div class="space-y-4"><select id="ppob-category-select" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-gray-700"><option value="">-- Pilih Kategori --</option></select><input type="number" id="ppob-customer-id" class="w-full p-3 rounded-lg bg-gray-200 dark:bg-gray-700 hidden" placeholder="Masukkan Nomor HP / ID Pelanggan"><div id="ppob-products-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div></div>
    </template>
    
    <template id="produk-page-template">
         <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h3 class="text-2xl font-bold">Manajemen Produk</h3>
                <div class="flex items-center gap-2">
                    <button id="import-csv-btn" class="bg-green-600 text-white py-2 px-4 rounded-lg flex items-center gap-2 hover:bg-green-700">
                        <i data-lucide="upload" class="w-5 h-5"></i><span>Impor CSV</span>
                    </button>
                    <button id="add-product-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-lg flex items-center gap-2 hover:bg-indigo-700">
                        <i data-lucide="plus" class="w-5 h-5"></i><span>Tambah Produk</span>
                    </button>
                </div>
            </div>
            <div id="product-stats-dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center"></div>
            <div class="flex flex-wrap gap-4 items-center">
                <div class="flex-grow">
                    <label for="product-manage-search" class="sr-only">Cari Produk</label>
                    <input type="text" id="product-manage-search" placeholder="Cari berdasarkan nama atau SKU..." class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">
                </div>
                <div class="flex-grow">
                    <label for="product-category-filter" class="sr-only">Filter Kategori</label>
                    <select id="product-category-filter" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600">
                        <option value="all">Semua Kategori</option>
                    </select>
                </div>
                <div id="bulk-action-container" class="hidden">
                    <button id="bulk-delete-btn" class="bg-red-600 text-white py-2 px-4 rounded-lg flex items-center gap-2 hover:bg-red-700">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                        <span>Hapus Terpilih</span>
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="border-b border-gray-200 dark:border-gray-700">
                        <tr>
                            <th class="p-3 w-4"><input type="checkbox" id="select-all-products-checkbox"></th>
                            <th class="p-3 sortable-header" data-sort="name">Produk</th>
                            <th class="p-3 sortable-header" data-sort="sku">SKU</th>
                            <th class="p-3 sortable-header" data-sort="cost_price">Harga Beli</th>
                            <th class="p-3 sortable-header" data-sort="price">Harga Jual</th>
                            <th class="p-3 sortable-header" data-sort="stock">Stok</th>
                            <th class="p-3">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="manage-product-table-body"></tbody>
                </table>
            </div>
            <div id="product-pagination-controls" class="flex justify-between items-center mt-4"></div>
         </div>
    </template>
    
    <template id="stok-page-template">
        <div class="space-y-6">
            <h3 class="text-2xl font-bold">Manajemen Stok</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl font-bold mb-4">Stok Masuk (Stock In)</h4>
                    <form id="stock-in-form" class="space-y-4">
                        <div>
                            <label for="stock-in-product" class="block mb-1 font-medium">Pilih Produk</label>
                            <select id="stock-in-product" required class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700"></select>
                        </div>
                        <div>
                            <label for="stock-in-quantity" class="block mb-1 font-medium">Jumlah Masuk</label>
                            <input type="number" id="stock-in-quantity" min="1" required class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700">
                        </div>
                        <div>
                            <label for="stock-in-notes" class="block mb-1 font-medium">Catatan (Opsional)</label>
                            <input type="text" id="stock-in-notes" placeholder="Contoh: Dari Pemasok A" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">Tambah Stok</button>
                    </form>
                </div>
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                    <h4 class="text-xl font-bold mb-4">Penyesuaian Stok</h4>
                    <form id="stock-adjustment-form" class="space-y-4">
                        <div>
                            <label for="adjustment-product" class="block mb-1 font-medium">Pilih Produk</label>
                            <select id="adjustment-product" required class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700"></select>
                        </div>
                        <div>
                            <label for="adjustment-quantity" class="block mb-1 font-medium">Jumlah Stok Baru</label>
                            <input type="number" id="adjustment-quantity" min="0" required class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700">
                        </div>
                        <div>
                            <label for="adjustment-notes" class="block mb-1 font-medium">Alasan Penyesuaian</label>
                            <input type="text" id="adjustment-notes" required placeholder="Contoh: Barang rusak, hilang" class="w-full p-2 rounded-lg bg-gray-100 dark:bg-gray-700">
                        </div>
                        <button type="submit" class="w-full bg-amber-500 text-white py-2 px-4 rounded-lg hover:bg-amber-600">Sesuaikan Stok</button>
                    </form>
                </div>
            </div>
        </div>
    </template>
    
    <template id="laporan-page-template">
        <div id="report-page-container" class="space-y-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <h3 class="text-2xl font-bold">Laporan Analisis</h3>
                <button id="export-report-btn" class="bg-blue-600 text-white py-2 px-4 rounded-lg flex items-center gap-2 hover:bg-blue-700">
                    <i data-lucide="download" class="w-5 h-5"></i><span>Unduh Laporan (PDF)</span>
                </button>
            </div>
            
            <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-md">
                <div class="flex flex-wrap items-end gap-4">
                    <div>
                        <label class="text-sm font-medium">Filter Cepat</label>
                        <div class="flex items-center gap-2 mt-1">
                            <button class="date-filter-btn active bg-indigo-600 text-white py-1 px-3 rounded-full text-sm" data-range="today">Hari Ini</button>
                            <button class="date-filter-btn bg-gray-200 dark:bg-gray-700 py-1 px-3 rounded-full text-sm" data-range="7days">7 Hari</button>
                            <button class="date-filter-btn bg-gray-200 dark:bg-gray-700 py-1 px-3 rounded-full text-sm" data-range="30days">30 Hari</button>
                        </div>
                    </div>
                    <div class="border-l border-gray-300 dark:border-gray-600 pl-4">
                        <label for="start-date-filter" class="text-sm font-medium">Rentang Kustom</label>
                        <div class="flex items-center gap-2 mt-1">
                            <input type="date" id="start-date-filter" class="p-1 border rounded-lg bg-gray-100 dark:bg-gray-700">
                            <span>-</span>
                            <input type="date" id="end-date-filter" class="p-1 border rounded-lg bg-gray-100 dark:bg-gray-700">
                            <button id="apply-date-range-btn" class="bg-indigo-600 text-white py-1 px-3 rounded-lg text-sm">Terapkan</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow flex items-center gap-4">
                    <div class="bg-green-100 dark:bg-green-900 p-3 rounded-full"><i data-lucide="trending-up" class="w-6 h-6 text-green-500"></i></div>
                    <div><p class="text-sm text-gray-500">Total Keuntungan</p><h3 id="report-total-profit" class="text-2xl font-bold">Rp 0</h3></div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow flex items-center gap-4">
                    <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-full"><i data-lucide="dollar-sign" class="w-6 h-6 text-blue-500"></i></div>
                    <div><p class="text-sm text-gray-500">Total Pendapatan</p><h3 id="report-total-revenue" class="text-2xl font-bold">Rp 0</h3></div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow flex items-center gap-4">
                    <div class="bg-orange-100 dark:bg-orange-900 p-3 rounded-full"><i data-lucide="shopping-cart" class="w-6 h-6 text-orange-500"></i></div>
                    <div><p class="text-sm text-gray-500">Jumlah Transaksi</p><h3 id="report-total-transactions" class="text-2xl font-bold">0</h3></div>
                </div>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow flex items-center gap-4">
                    <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-full"><i data-lucide="package-check" class="w-6 h-6 text-purple-500"></i></div>
                    <div><p class="text-sm text-gray-500">Produk Terlaris</p><h3 id="report-best-seller" class="text-xl font-bold truncate">-</h3></div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-3 bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
                    <h4 class="font-bold mb-2">Penjualan per Hari</h4>
                    <canvas id="sales-chart"></canvas>
                </div>
                <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
                    <h4 class="font-bold mb-2">Penjualan per Kategori</h4>
                    <canvas id="category-sales-chart"></canvas>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg">
                <h3 class="text-2xl font-bold mb-4">Detail Transaksi</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="border-b border-gray-200 dark:border-gray-700">
                            <tr>
                                <th class="p-3">ID</th>
                                <th class="p-3">Tanggal</th>
                                <th class="p-3">Total</th>
                                <th class="p-3">Keuntungan</th>
                                <th class="p-3">Metode Bayar</th>
                                <th class="p-3">Status</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </template>
    
    <template id="pengaturan-page-template">
        <div class="flex flex-col md:flex-row gap-6">
            <div class="w-full md:w-1/4">
                <ul class="space-y-1">
                    <li><button data-tab="toko" class="setting-tab-btn w-full text-left p-3 rounded-lg font-semibold">Toko & Umum</button></li>
                    <li><button data-tab="tampilan" class="setting-tab-btn w-full text-left p-3 rounded-lg font-semibold">Tampilan</button></li>
                    <li><button data-tab="struk" class="setting-tab-btn w-full text-left p-3 rounded-lg font-semibold">Perangkat & Struk</button></li>
                    <li><button data-tab="pajak" class="setting-tab-btn w-full text-left p-3 rounded-lg font-semibold">Pajak & Biaya</button></li>
                    <li><button data-tab="integrasi" class="setting-tab-btn w-full text-left p-3 rounded-lg font-semibold">Integrasi</button></li>
                </ul>
            </div>
            <div class="w-full md:w-3/4">
                <div id="setting-content"></div>
            </div>
        </div>
    </template>

    <template id="setting-tab-toko">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-6">
            <h3 class="text-2xl font-bold border-b pb-2 dark:border-gray-700">Pengaturan Toko & Umum</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div><label for="store-name" class="block mb-2 font-medium">Nama Toko</label><input type="text" id="store-name" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div>
                <div><label for="store-address" class="block mb-2 font-medium">Alamat Toko</label><input type="text" id="store-address" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div>
                <div><label for="store-phone" class="block mb-2 font-medium">No. Telepon</label><input type="text" id="store-phone" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div>
                <div><label for="store-npwp" class="block mb-2 font-medium">NPWP</label><input type="text" id="store-npwp" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div>
                <div class="md:col-span-2 flex items-end gap-4">
                    <img id="store-logo-preview" src="https://placehold.co/80x80" class="w-20 h-20 rounded-lg object-cover bg-gray-200">
                    <div>
                        <label for="store-logo-input" class="block mb-2 font-medium">Logo Toko</label>
                        <input type="file" id="store-logo-input" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    </div>
                </div>
            </div>
            <button id="save-settings-btn" class="mt-6 bg-indigo-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                <i data-lucide="save" class="w-5 h-5"></i>
                <span>Simpan Pengaturan</span>
            </button>
        </div>
    </template>
    
    <template id="setting-tab-tampilan">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-6">
            <h3 class="text-2xl font-bold border-b pb-2 dark:border-gray-700">Tampilan & Personalisasi</h3>
            <div>
                <label class="block mb-2 font-medium">Font Aplikasi</label>
                <select id="app-font" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700">
                    <option value="font-inter">Inter (Default)</option>
                    <option value="font-poppins">Poppins</option>
                    <option value="font-lato">Lato</option>
                </select>
            </div>
            <button id="save-settings-btn" class="mt-6 bg-indigo-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                <i data-lucide="save" class="w-5 h-5"></i>
                <span>Simpan Pengaturan</span>
            </button>
        </div>
    </template>
    
    <template id="setting-tab-struk">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-6">
            <h3 class="text-2xl font-bold border-b pb-2 dark:border-gray-700">Perangkat & Struk</h3>
            <div>
                <label class="block mb-2 font-medium">Ukuran Kertas Printer</label>
                <select id="receipt-paper-size" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700">
                    <option value="58mm">58mm</option>
                    <option value="80mm">80mm</option>
                </select>
            </div>
            <div>
                <label class="block mb-2 font-medium">Teks Footer Struk</label>
                <textarea id="receipt-footer" rows="3" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700" placeholder="Contoh: Terima kasih telah berbelanja!"></textarea>
            </div>
            <button id="save-settings-btn" class="mt-6 bg-indigo-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                <i data-lucide="save" class="w-5 h-5"></i>
                <span>Simpan Pengaturan</span>
            </button>
        </div>
    </template>

    <template id="setting-tab-pajak">
         <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-6">
            <h3 class="text-2xl font-bold border-b pb-2 dark:border-gray-700">Pajak & Biaya</h3>
            <div class="flex items-center justify-between">
                <label for="tax-enabled" class="font-medium">Aktifkan Pajak (PPN)</label>
                <input type="checkbox" id="tax-enabled" class="toggle-checkbox h-6 w-11 rounded-full bg-gray-300 dark:bg-gray-600 appearance-none checked:bg-indigo-600 transition duration-200 ease-in-out relative">
            </div>
            <div id="tax-details" class="hidden">
                 <label for="tax-percent" class="block mb-2 font-medium">Persentase Pajak (%)</label>
                 <input type="number" id="tax-percent" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700">
            </div>
            <button id="save-settings-btn" class="mt-6 bg-indigo-600 text-white py-2 px-6 rounded-lg hover:bg-indigo-700 flex items-center gap-2">
                <i data-lucide="save" class="w-5 h-5"></i>
                <span>Simpan Pengaturan</span>
            </button>
        </div>
    </template>
    
    <template id="setting-tab-integrasi">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg space-y-6">
            <h3 class="text-2xl font-bold border-b pb-2 dark:border-gray-700">Integrasi PPOB (Digiflazz)</h3>
            <p class="text-sm text-gray-500">Kredensial API Digiflazz Anda akan diambil dari environment variables yang telah diatur di Supabase.</p>
            <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg text-yellow-800">
                Fitur ini memerlukan penundaan dan konfigurasi di backend (Edge Functions).
            </div>
        </div>
    </template>
    
    <!-- MODAL TEMPLATES -->
    <template id="payment-modal-template">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"><div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-md p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold">Pembayaran</h3><button class="close-modal-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button></div><div class="space-y-4"><div class="text-center py-4 bg-gray-100 dark:bg-gray-700 rounded-lg"><p class="text-gray-500">Total Tagihan</p><p id="modal-total" class="text-4xl font-bold text-indigo-600 dark:text-indigo-400">Rp 0</p></div><div><label class="font-medium">Metode Pembayaran</label><select id="payment-method" class="w-full p-3 mt-2 rounded-lg bg-gray-200 dark:bg-gray-700"><option value="Tunai">Tunai</option><option value="QRIS">QRIS</option><option value="Debit">Kartu Debit</option></select></div><div id="cash-payment-fields"><label for="cash-received" class="font-medium">Uang Diterima</label><input type="number" id="cash-received" class="w-full p-3 mt-2 rounded-lg bg-gray-200 dark:bg-gray-700" placeholder="Masukkan jumlah uang tunai"><div class="mt-2 text-right"><span>Kembalian:</span><span id="cash-change" class="font-bold">Rp 0</span></div></div><button id="confirm-payment-btn" class="w-full bg-green-600 text-white p-4 rounded-lg font-bold text-lg hover:bg-green-700 disabled:bg-gray-400" disabled>Selesaikan Pembayaran</button></div></div></div>
    </template>
    
    <template id="receipt-overlay-template">
        <div id="receipt-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex flex-col items-center justify-center z-[60] p-4">
            <div id="receipt-paper" class="bg-white rounded-lg shadow-2xl w-full max-w-sm">
                <div id="receipt-content"></div>
            </div>
            <div class="flex gap-4 mt-6 no-print">
                <button id="close-receipt-overlay-btn" class="flex-1 bg-gray-200 dark:bg-gray-600 py-3 rounded-lg font-semibold flex items-center justify-center gap-2"><i data-lucide="x" class="w-5 h-5"></i>Tutup</button>
                <button id="print-receipt-btn" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2"><i data-lucide="printer" class="w-5 h-5"></i>Cetak</button>
            </div>
        </div>
    </template>
    
    <template id="add-product-modal-template">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"><form id="add-product-form" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg p-6 space-y-4"><div class="flex justify-between items-center mb-2"><h3 class="text-2xl font-bold">Tambah Produk Baru</h3><button type="button" class="close-modal-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="product-name" class="block mb-1 font-medium">Nama Produk</label><input type="text" id="product-name" required class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div><div><label for="product-sku" class="block mb-1 font-medium">SKU / Barcode</label><div class="flex"><input type="text" id="product-sku" class="w-full p-2 rounded-l-lg bg-gray-200 dark:bg-gray-700"><button type="button" id="scan-sku-btn" class="p-2 bg-indigo-600 text-white rounded-r-lg hover:bg-indigo-700 flex items-center"><i data-lucide="camera" class="w-5 h-5"></i></button></div></div><div><label for="product-cost-price" class="block mb-1 font-medium">Harga Beli (Modal)</label><input type="number" id="product-cost-price" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div><div><label for="product-price" class="block mb-1 font-medium">Harga Jual</label><input type="number" id="product-price" required class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div><div><label for="product-stock" class="block mb-1 font-medium">Stok Awal</label><input type="number" id="product-stock" required class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div><div><label for="product-category" class="block mb-1 font-medium">Kategori</label><input type="text" id="product-category" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div><div class="md:col-span-2"><label for="product-image-url" class="block mb-1 font-medium">URL Gambar (Opsional)</label><input type="text" id="product-image-url" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="close-modal-btn py-2 px-4 rounded-lg bg-gray-200 dark:bg-gray-600 font-semibold">Batal</button><button type="submit" id="save-product-btn" class="py-2 px-6 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Simpan</button></div></form></div>
    </template>

    <template id="edit-product-modal-template">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"><form id="edit-product-form" class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg p-6 space-y-4"><div class="flex justify-between items-center mb-2"><h3 class="text-2xl font-bold">Edit Produk</h3><button type="button" class="close-modal-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button></div><input type="hidden" id="edit-product-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="edit-product-name" class="block mb-1 font-medium">Nama Produk</label><input type="text" id="edit-product-name" required class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div><div><label for="edit-product-sku" class="block mb-1 font-medium">SKU / Barcode</label><input type="text" id="edit-product-sku" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div><div><label for="edit-product-cost-price" class="block mb-1 font-medium">Harga Beli (Modal)</label><input type="number" id="edit-product-cost-price" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div><div><label for="edit-product-price" class="block mb-1 font-medium">Harga Jual</label><input type="number" id="edit-product-price" required class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div><div><label for="edit-product-stock" class="block mb-1 font-medium">Stok</label><input type="number" id="edit-product-stock" required class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div><div><label for="edit-product-category" class="block mb-1 font-medium">Kategori</label><input type="text" id="edit-product-category" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div><div class="md:col-span-2"><label for="edit-product-image-url" class="block mb-1 font-medium">URL Gambar (Opsional)</label><input type="text" id="edit-product-image-url" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700"></div></div><div class="flex justify-end gap-4 pt-4"><button type="button" class="close-modal-btn py-2 px-4 rounded-lg bg-gray-200 dark:bg-gray-600 font-semibold">Batal</button><button type="submit" id="update-product-btn" class="py-2 px-6 rounded-lg bg-indigo-600 text-white font-semibold hover:bg-indigo-700">Simpan Perubahan</button></div></form></div>
    </template>
    
    <template id="confirm-modal-template">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-sm p-6 text-center">
                <i data-lucide="alert-triangle" class="w-16 h-16 mx-auto text-amber-500 mb-4"></i>
                <h3 id="confirm-title" class="text-xl font-bold mb-2">Konfirmasi</h3>
                <p id="confirm-message" class="text-gray-600 dark:text-gray-300 mb-6">Apakah Anda yakin?</p>
                <div class="flex justify-center gap-4">
                    <button id="confirm-cancel-btn" class="py-2 px-6 rounded-lg bg-gray-200 dark:bg-gray-600 font-semibold">Batal</button>
                    <button id="confirm-ok-btn" class="py-2 px-6 rounded-lg bg-red-600 text-white font-semibold">Ya, Lanjutkan</button>
                </div>
            </div>
        </div>
    </template>

    <template id="discount-modal-template">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-sm p-6">
                <h3 class="text-xl font-bold mb-4">Beri Diskon</h3>
                <div class="space-y-4">
                    <div>
                        <label for="discount-amount" class="block mb-1 font-medium">Jumlah Diskon (Rp)</label>
                        <input type="number" id="discount-amount" placeholder="Contoh: 5000" class="w-full p-2 rounded-lg bg-gray-200 dark:bg-gray-700">
                    </div>
                    <div class="flex items-center justify-end gap-4">
                        <button class="close-modal-btn py-2 px-4 rounded-lg bg-gray-200 dark:bg-gray-600 font-semibold">Batal</button>
                        <button id="apply-discount-btn" class="py-2 px-6 rounded-lg bg-indigo-600 text-white font-semibold">Terapkan</button>
                    </div>
                </div>
            </div>
        </div>
    </template>
    
    <template id="transaction-detail-modal-template">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-lg p-6 space-y-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-2xl font-bold">Detail Transaksi</h3>
                    <button type="button" class="close-modal-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button>
                </div>
                <div id="transaction-detail-content" class="text-sm"></div>
            </div>
        </div>
    </template>

    <template id="stock-history-modal-template">
        <div class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50 p-4">
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg w-full max-w-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">Riwayat Stok</h3>
                    <button type="button" class="close-modal-btn p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">&times;</button>
                </div>
                <div id="stock-history-content" class="max-h-[60vh] overflow-y-auto"></div>
            </div>
        </div>
    </template>
    

    <script type="module">
        const { createClient } = supabase;
        const supabaseUrl = 'https://ptmvqofkioevyxcoqqyr.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB0bXZxb2ZraW9ldnl4Y29xcXlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzQ4NzUsImV4cCI6MjA2Njk1MDg3NX0.ItZ6Nhp7y2j5RtQ7R5QhwZXv5zlFdiO0j1t2RMXA3Io';
        const db = createClient(supabaseUrl, supabaseKey);

        const app = {
            state: {
                currentPage: 'kasir',
                online: navigator.onLine,
                cart: [],
                heldCarts: [],
                cartDiscount: 0, 
                products: [],
                productManagement: {
                    filters: { search: '', category: 'all' },
                    sorting: { column: 'name', direction: 'asc' },
                    pagination: { currentPage: 1, productsPerPage: 10, totalProducts: 0 },
                    selectedProducts: [],
                    lowStockThreshold: 5,
                },
                kasir: {
                    categoryFilter: 'all'
                },
                ppobProducts: [],
                transactions: [],
                settings: {
                    id: 1, 
                    store_name: 'Toko Anda',
                    store_address: 'Jl. Pahlawan No. 123',
                    store_phone: '081234567890',
                    store_npwp: '',
                    store_logo_url: 'https://placehold.co/80x80/4f46e5/ffffff?text=P',
                    receipt_footer: 'Terima kasih telah berbelanja!',
                    app_font: 'font-inter',
                    receipt_paper_size: '58mm',
                    tax_enabled: false,
                    tax_percent: 0,
                },
                lastTransaction: null,
                scanContext: 'kasir',
                charts: {}, 
            },
            async init() {
                this.debug.log('Aplikasi mulai dijalankan...');
                await this.data.loadSettings();
                this.ui.initTheme();
                this.pwa.init();
                this.router.init();
                this.events.init();
                this.sync.init();
                this.draggable.init();
                this.barcode.initPhysicalScanner();
                
                this.debug.log(`URL Supabase: ${supabaseUrl.substring(0, 20)}...`);
                
                this.ui.updateStoreInfo();
                await this.data.loadProducts();
                await this.data.loadTransactions();
                this.router.navigateTo('kasir');

                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            },
            
            toast: {
                show(message, type = 'info', duration = 3000) {
                    const container = document.getElementById('toast-container');
                    const toast = document.createElement('div');
                    toast.className = `toast toast-${type}`;
                    let icon = 'info';
                    if (type === 'success') icon = 'check-circle';
                    if (type === 'error') icon = 'x-circle';
                    toast.innerHTML = `<i data-lucide="${icon}" class="w-5 h-5 mr-3"></i><span>${message}</span>`;
                    container.appendChild(toast);
                    if (typeof lucide !== 'undefined') {
                       lucide.createIcons({ nodes: [toast.querySelector('i')] });
                    }
                    setTimeout(() => toast.classList.add('show'), 10);
                    setTimeout(() => {
                        toast.classList.remove('show');
                        toast.addEventListener('transitionend', () => toast.remove());
                    }, duration);
                }
            },

            debug: {
                log(message) {
                    console.log(message);
                    const debugContent = document.getElementById('debug-content');
                    if (debugContent) {
                        const p = document.createElement('p');
                        p.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                        debugContent.prepend(p);
                    }
                },
                clear() {
                    const debugContent = document.getElementById('debug-content');
                    if (debugContent) debugContent.innerHTML = '';
                }
            },
            
            draggable: {
                active: false, currentX: 0, currentY: 0, initialX: 0, initialY: 0, xOffset: 0, yOffset: 0, dragItem: null,
                init() {
                    const consoleHeader = document.getElementById('debug-console-header');
                    this.dragItem = document.getElementById('debug-console');
                    if(consoleHeader) {
                        consoleHeader.addEventListener("mousedown", this.dragStart.bind(this));
                        window.addEventListener("mouseup", this.dragEnd.bind(this));
                        window.addEventListener("mousemove", this.drag.bind(this));
                    }
                },
                dragStart(e) {
                    if (e.target.id === 'debug-console-header') {
                        this.initialX = e.clientX - this.xOffset; this.initialY = e.clientY - this.yOffset; this.active = true;
                    }
                },
                dragEnd(e) {
                    if (this.active) {
                        this.initialX = this.currentX; this.initialY = this.currentY; this.active = false;
                    }
                },
                drag(e) {
                    if (this.active) {
                        e.preventDefault();
                        this.currentX = e.clientX - this.initialX; this.currentY = e.clientY - this.initialY;
                        this.xOffset = this.currentX; this.yOffset = this.currentY;
                        this.setTranslate(this.currentX, this.currentY, this.dragItem);
                    }
                },
                setTranslate(xPos, yPos, el) { el.style.transform = `translate3d(${xPos}px, ${yPos}px, 0)`; }
            },

            ui: {
                renderPage(pageId) {
                    try {
                        const pageContent = document.getElementById('page-content');
                        const template = document.getElementById(`${pageId}-page-template`);
                        if (!template) {
                            app.debug.log(`Error: Template untuk halaman '${pageId}' tidak ditemukan.`);
                            return;
                        }
                        pageContent.innerHTML = template.innerHTML;
                        this.afterRender(pageId);
                    } catch (error) {
                        app.debug.log(`Error saat renderPage '${pageId}': ${error.message}`);
                    }
                },

                afterRender(pageId) {
                    if (pageId === 'kasir') this.renderKasirTab('toko');
                    if (pageId === 'produk') this.renderProductManagementPage();
                    if (pageId === 'stok') this.renderStockManagementPage();
                    if (pageId === 'laporan') app.reports.init();
                    if (pageId === 'pengaturan') this.renderSettingsPage();
                    if (typeof lucide !== 'undefined') {
                       lucide.createIcons();
                    }
                },
                
                renderKasirTab(tabId) {
                    const kasirContent = document.getElementById('kasir-content');
                    const templateId = tabId === 'toko' ? 'produk-toko-template' : 'ppob-template';
                    kasirContent.innerHTML = document.getElementById(templateId).innerHTML;
                    
                    document.querySelectorAll('.tab-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.tab === tabId);
                        btn.classList.toggle('text-gray-500', btn.dataset.tab !== tabId);
                    });
                    
                    if(tabId === 'toko') {
                        this.renderKasirCategoryFilter();
                        this.renderProductGrid();
                    }
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                },
                
                renderProductGrid() {
                    const productList = document.getElementById('product-list');
                    if (!productList) return;

                    const filterText = document.getElementById('product-search')?.value.toLowerCase() || '';
                    const categoryFilter = app.state.kasir.categoryFilter;

                    const filteredProducts = app.state.products.filter(p => {
                        const searchMatch = p.name.toLowerCase().includes(filterText) || (p.sku && p.sku.includes(filterText));
                        const categoryMatch = categoryFilter === 'all' || p.category === categoryFilter;
                        return searchMatch && categoryMatch;
                    });

                    if (filteredProducts.length === 0) {
                        productList.innerHTML = `<p class="col-span-full text-center text-gray-500">Produk tidak ditemukan.</p>`;
                        return;
                    }
                    productList.innerHTML = filteredProducts.map(product => `
                        <div class="product-card bg-white dark:bg-gray-800 rounded-lg shadow p-3 flex flex-col cursor-pointer hover:ring-2 hover:ring-indigo-500" data-id="${product.id}">
                            <img src="${product.image_url || 'https://placehold.co/300x300/e2e8f0/64748b?text=Produk'}" alt="${product.name}" class="w-full h-24 object-cover rounded-md mb-2">
                            <h4 class="font-semibold text-sm flex-grow">${product.name}</h4>
                            <p class="font-bold text-indigo-600 dark:text-indigo-400">${app.util.formatCurrency(product.price)}</p>
                            <p class="text-xs text-gray-500">Stok: ${product.stock}</p>
                        </div>
                    `).join('');
                },
                
                updateCart() {
                    const cartItems = document.getElementById('cart-items');
                    if (app.state.cart.length === 0) {
                        cartItems.innerHTML = `<div class="text-center py-10 text-gray-500"><i data-lucide="shopping-basket" class="w-16 h-16 mx-auto mb-2"></i><p>Keranjang masih kosong</p></div>`;
                    } else {
                        cartItems.innerHTML = app.state.cart.map(item => `
                            <div class="flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700">
                                <div><p class="font-semibold">${item.name}</p><p class="text-sm text-gray-500">${app.util.formatCurrency(item.price)}</p></div>
                                <div class="flex items-center gap-2">
                                    <button class="update-qty-btn p-1 rounded-full bg-gray-200 dark:bg-gray-600" data-id="${item.id || item.buyer_sku_code}" data-change="-1">-</button>
                                    <input type="number" class="cart-item-qty-input w-12 text-center bg-gray-100 dark:bg-gray-700 rounded" value="${item.quantity}" data-id="${item.id || item.buyer_sku_code}">
                                    <button class="update-qty-btn p-1 rounded-full bg-gray-200 dark:bg-gray-600" data-id="${item.id || item.buyer_sku_code}" data-change="1">+</button>
                                </div>
                                <p class="font-bold w-20 text-right">${app.util.formatCurrency(item.price * item.quantity)}</p>
                                <button class="remove-from-cart-btn text-red-500 hover:text-red-700 p-1" data-id="${item.id || item.buyer_sku_code}">&times;</button>
                            </div>
                        `).join('');
                    }
                    const subtotal = app.state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const discount = app.state.cartDiscount;
                    const total = subtotal - discount;
                    document.getElementById('cart-subtotal').textContent = app.util.formatCurrency(subtotal);
                    document.getElementById('cart-discount').textContent = `- ${app.util.formatCurrency(discount)}`;
                    document.getElementById('cart-total').textContent = app.util.formatCurrency(total);
                    const hasItems = app.state.cart.length > 0;
                    document.getElementById('pay-btn').disabled = !hasItems;
                    document.getElementById('discount-btn').disabled = !hasItems;
                    document.getElementById('clear-cart-btn').disabled = !hasItems;
                    document.getElementById('hold-cart-btn').disabled = !hasItems;

                    const badge = document.getElementById('held-cart-badge');
                    if (app.state.heldCarts.length > 0) {
                        badge.textContent = app.state.heldCarts.length;
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }

                    if (typeof lucide !== 'undefined') lucide.createIcons();
                },

                renderModal(templateId, data = {}) {
                    const template = document.getElementById(templateId);
                    if (!template) return;
                    const modalContainer = document.getElementById('modal-container');
                    modalContainer.innerHTML = template.innerHTML;
                    if (templateId === 'payment-modal-template') {
                        const subtotal = app.state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                        const total = subtotal - app.state.cartDiscount;
                        modalContainer.querySelector('#modal-total').textContent = app.util.formatCurrency(total);
                        app.kasir.validatePayment();
                    }
                    if (templateId === 'edit-product-modal-template' && data.product) {
                        const p = data.product;
                        document.getElementById('edit-product-id').value = p.id;
                        document.getElementById('edit-product-name').value = p.name;
                        document.getElementById('edit-product-sku').value = p.sku;
                        document.getElementById('edit-product-cost-price').value = p.cost_price;
                        document.getElementById('edit-product-price').value = p.price;
                        document.getElementById('edit-product-stock').value = p.stock;
                        document.getElementById('edit-product-category').value = p.category;
                        document.getElementById('edit-product-image-url').value = p.image_url;
                    }
                    if (templateId === 'confirm-modal-template') {
                        document.getElementById('confirm-title').textContent = data.title;
                        document.getElementById('confirm-message').textContent = data.message;
                        const okBtn = document.getElementById('confirm-ok-btn');
                        const cancelBtn = document.getElementById('confirm-cancel-btn');
                        okBtn.onclick = () => { data.onConfirm(); this.closeModal(); };
                        cancelBtn.onclick = () => this.closeModal();
                    }
                    if (templateId === 'transaction-detail-modal-template' && data.transaction) {
                        app.reports.renderTransactionDetail(data.transaction);
                    }
                    if (templateId === 'stock-history-modal-template' && data.history) {
                        this.renderStockHistoryModalContent(data.history);
                    }
                    if (templateId === 'held-carts-modal-template') {
                        app.kasir.renderHeldCarts();
                    }
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                },
                
                showReceiptOverlay(transaction) {
                    const template = document.getElementById('receipt-overlay-template');
                    if (!template) return;
                    const modalContainer = document.getElementById('modal-container');
                    modalContainer.innerHTML = template.innerHTML;
                    const receiptContent = document.getElementById('receipt-content');
                    receiptContent.innerHTML = this.generateReceiptHTML(transaction);
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                },

                closeModal() {
                    document.getElementById('modal-container').innerHTML = '';
                },
                
                renderProductManagementPage() {
                    const { filters, sorting, pagination } = app.state.productManagement;
                    let processedProducts = [...app.state.products];
                    processedProducts = processedProducts.filter(p => {
                        const searchMatch = p.name.toLowerCase().includes(filters.search.toLowerCase()) || (p.sku && p.sku.toLowerCase().includes(filters.search.toLowerCase()));
                        const categoryMatch = filters.category === 'all' || p.category === filters.category;
                        return searchMatch && categoryMatch;
                    });
                    processedProducts.sort((a, b) => {
                        const valA = a[sorting.column];
                        const valB = b[sorting.column];
                        let comparison = 0;
                        if (typeof valA === 'string') {
                            comparison = (valA || '').localeCompare(valB || '');
                        } else {
                            comparison = (valA || 0) - (valB || 0);
                        }
                        return sorting.direction === 'asc' ? comparison : -comparison;
                    });
                    pagination.totalProducts = processedProducts.length;
                    const startIndex = (pagination.currentPage - 1) * pagination.productsPerPage;
                    const endIndex = startIndex + pagination.productsPerPage;
                    const paginatedProducts = processedProducts.slice(startIndex, endIndex);
                    this.renderProductDashboard();
                    this.renderProductCategoryFilter();
                    this.renderProductTable(paginatedProducts);
                    this.renderProductPagination();
                    this.updateBulkActionUI();
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                },

                renderProductTable(productsToRender) {
                    const tableBody = document.getElementById('manage-product-table-body');
                    if (!tableBody) return;
                    document.querySelectorAll('.sortable-header').forEach(header => {
                        header.innerHTML = header.textContent;
                        const sortKey = header.dataset.sort;
                        if (sortKey === app.state.productManagement.sorting.column) {
                            const icon = app.state.productManagement.sorting.direction === 'asc' ? 'arrow-up' : 'arrow-down';
                            header.innerHTML += ` <i data-lucide="${icon}" class="inline-block w-4 h-4"></i>`;
                        }
                    });
                    if (productsToRender.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="7" class="text-center p-4 text-gray-500">Tidak ada produk yang cocok.</td></tr>`;
                        return;
                    }
                    tableBody.innerHTML = productsToRender.map(p => {
                        const isLowStock = p.stock <= app.state.productManagement.lowStockThreshold;
                        const lowStockClass = isLowStock ? 'low-stock-row' : '';
                        const isSelected = app.state.productManagement.selectedProducts.includes(p.id);
                        return `
                            <tr class="border-b dark:border-gray-700 ${lowStockClass}">
                                <td class="p-3"><input type="checkbox" class="product-checkbox" data-id="${p.id}" ${isSelected ? 'checked' : ''}></td>
                                <td class="p-3 flex items-center gap-3"><img src="${p.image_url || 'https://placehold.co/40x40'}" class="w-10 h-10 rounded object-cover"><span>${p.name || ''}</span></td>
                                <td class="p-3">${p.sku || '-'}</td>
                                <td class="p-3">${app.util.formatCurrency(p.cost_price || 0)}</td>
                                <td class="p-3">${app.util.formatCurrency(p.price || 0)}</td>
                                <td class="p-3 font-bold ${isLowStock ? 'text-red-500' : ''}">${p.stock ?? 0}</td>
                                <td class="p-3">
                                    <div class="flex gap-2">
                                        <button class="stock-history-btn p-2 text-gray-600 hover:bg-gray-100 rounded-md" data-id="${p.id}"><i data-lucide="history" class="w-4 h-4"></i></button>
                                        <button class="edit-product-btn p-2 text-indigo-600 hover:bg-indigo-100 rounded-md" data-id="${p.id}"><i data-lucide="edit" class="w-4 h-4"></i></button>
                                        <button class="delete-product-btn p-2 text-red-600 hover:bg-red-100 rounded-md" data-id="${p.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                </td>
                            </tr>`;
                    }).join('');
                },

                renderProductCategoryFilter() {
                    const filterEl = document.getElementById('product-category-filter');
                    if (!filterEl) return;
                    const categories = [...new Set(app.state.products.map(p => p.category).filter(Boolean))];
                    filterEl.innerHTML = '<option value="all">Semua Kategori</option>';
                    filterEl.innerHTML += categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                    filterEl.value = app.state.productManagement.filters.category;
                },

                renderProductPagination() {
                    const controlsEl = document.getElementById('product-pagination-controls');
                    if (!controlsEl) return;
                    const { currentPage, productsPerPage, totalProducts } = app.state.productManagement.pagination;
                    const totalPages = Math.ceil(totalProducts / productsPerPage);
                    if (totalPages <= 1) {
                        controlsEl.innerHTML = '';
                        return;
                    }
                    const startIndex = (currentPage - 1) * productsPerPage + 1;
                    const endIndex = Math.min(startIndex + productsPerPage - 1, totalProducts);
                    controlsEl.innerHTML = `
                        <span class="text-sm text-gray-600 dark:text-gray-400">Menampilkan ${startIndex}-${endIndex} dari ${totalProducts} produk</span>
                        <div class="flex gap-2">
                            <button id="prev-page-btn" class="px-3 py-1 border rounded-lg ${currentPage === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}" ${currentPage === 1 ? 'disabled' : ''}>Sebelumnya</button>
                            <button id="next-page-btn" class="px-3 py-1 border rounded-lg ${currentPage === totalPages ? 'opacity-50 cursor-not-allowed' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}" ${currentPage === totalPages ? 'disabled' : ''}>Berikutnya</button>
                        </div>`;
                },
                
                renderProductDashboard() {
                    const dashboardEl = document.getElementById('product-stats-dashboard');
                    if (!dashboardEl) return;
                    const totalProducts = app.state.products.length;
                    const lowStockProducts = app.state.products.filter(p => p.stock <= app.state.productManagement.lowStockThreshold).length;
                    const inventoryValue = app.state.products.reduce((sum, p) => sum + ((p.cost_price || 0) * p.stock), 0);
                    dashboardEl.innerHTML = `
                        <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-gray-500">Total Produk</h4>
                            <p class="text-3xl font-bold">${totalProducts}</p>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-gray-500">Produk Stok Rendah</h4>
                            <p class="text-3xl font-bold text-amber-500">${lowStockProducts}</p>
                        </div>
                        <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded-lg">
                            <h4 class="text-sm font-medium text-gray-500">Nilai Inventaris</h4>
                            <p class="text-3xl font-bold">${app.util.formatCurrency(inventoryValue)}</p>
                        </div>`;
                },
                
                updateBulkActionUI() {
                    const container = document.getElementById('bulk-action-container');
                    if (!container) return;
                    const selectedCount = app.state.productManagement.selectedProducts.length;
                    if (selectedCount > 0) {
                        container.classList.remove('hidden');
                        container.querySelector('span').textContent = `Hapus (${selectedCount}) Terpilih`;
                    } else {
                        container.classList.add('hidden');
                    }
                },

                renderReportTable(filteredTransactions) {
                    const tableBody = document.getElementById('report-table-body');
                    if (!tableBody) return;
                     if (filteredTransactions.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">Tidak ada transaksi pada periode ini.</td></tr>`;
                        return;
                    }
                    tableBody.innerHTML = filteredTransactions.map(t => {
                        const profit = t.items.reduce((sum, item) => sum + ((item.price - (item.cost_price || item.price)) * item.quantity), 0);
                        return `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer transaction-row" data-transaction-id="${t.local_id || t.id}">
                            <td class="p-3 font-mono text-xs">${t.id ? String(t.id).substring(0, 8) : t.local_id.substring(0,8)}</td>
                            <td class="p-3">${new Date(t.created_at).toLocaleString('id-ID', { dateStyle: 'short', timeStyle: 'short' })}</td>
                            <td class="p-3 font-semibold">${app.util.formatCurrency(t.total_amount)}</td>
                            <td class="p-3 font-semibold text-green-600">${app.util.formatCurrency(profit)}</td>
                            <td class="p-3">${t.payment_method}</td>
                            <td class="p-3"><span class="px-2 py-1 text-xs rounded-full ${t.synced ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">${t.synced ? 'Tersinkronisasi' : 'Lokal'}</span></td>
                        </tr>
                    `}).join('');
                },

                renderSettingsPage() {
                    const content = document.getElementById('setting-content');
                    const tabs = document.querySelectorAll('.setting-tab-btn');
                    const renderTabContent = (tabId) => {
                        const template = document.getElementById(`setting-tab-${tabId}`);
                        if(template) {
                            content.innerHTML = template.innerHTML;
                            this.populateSettingsForm();
                            if(typeof lucide !== 'undefined') lucide.createIcons();
                        }
                    };
                    tabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            tabs.forEach(t => t.classList.remove('bg-indigo-100', 'dark:bg-gray-700'));
                            tab.classList.add('bg-indigo-100', 'dark:bg-gray-700');
                            renderTabContent(tab.dataset.tab);
                        });
                    });
                    tabs[0].classList.add('bg-indigo-100', 'dark:bg-gray-700');
                    renderTabContent(tabs[0].dataset.tab);
                },
                
                populateSettingsForm() {
                    const settings = app.state.settings;
                    if(document.getElementById('store-name')) document.getElementById('store-name').value = settings.store_name;
                    if(document.getElementById('store-address')) document.getElementById('store-address').value = settings.store_address;
                    if(document.getElementById('store-phone')) document.getElementById('store-phone').value = settings.store_phone;
                    if(document.getElementById('store-npwp')) document.getElementById('store-npwp').value = settings.store_npwp;
                    if(document.getElementById('store-logo-preview')) document.getElementById('store-logo-preview').src = settings.store_logo_url;
                    if(document.getElementById('app-font')) document.getElementById('app-font').value = settings.app_font;
                    if(document.getElementById('receipt-paper-size')) document.getElementById('receipt-paper-size').value = settings.receipt_paper_size;
                    if(document.getElementById('receipt-footer')) document.getElementById('receipt-footer').value = settings.receipt_footer;
                    if(document.getElementById('tax-enabled')) {
                        const taxEnabledCheckbox = document.getElementById('tax-enabled');
                        const taxDetailsDiv = document.getElementById('tax-details');
                        taxEnabledCheckbox.checked = settings.tax_enabled;
                        taxDetailsDiv.style.display = settings.tax_enabled ? 'block' : 'none';
                        if(document.getElementById('tax-percent')) document.getElementById('tax-percent').value = settings.tax_percent;
                    }
                },
                
                initTheme() {
                    document.body.className = `bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 ${app.state.settings.app_font}`;
                    if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                        document.documentElement.classList.add('dark');
                    } else {
                        document.documentElement.classList.remove('dark');
                    }
                },
                
                toggleTheme() {
                    document.documentElement.classList.toggle('dark');
                    localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
                },
                
                updateOnlineStatus() {
                    const statusDiv = document.getElementById('online-status');
                    if (app.state.online) statusDiv.innerHTML = `<span class="w-3 h-3 bg-green-500 rounded-full"></span><span class="ml-2 hidden lg:inline">Online</span>`;
                    else statusDiv.innerHTML = `<span class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></span><span class="ml-2 hidden lg:inline">Offline</span>`;
                },
                
                updateStoreInfo() {
                    document.getElementById('store-name-sidebar').textContent = app.state.settings.store_name;
                    document.getElementById('store-logo-sidebar').src = app.state.settings.store_logo_url;
                },

                generateReceiptHTML(transaction) {
                    if (!transaction) {
                        app.debug.log("generateReceiptHTML dipanggil dengan transaksi null.");
                        return '<div>Data transaksi tidak valid untuk dicetak.</div>';
                    }
                    const settings = app.state.settings;
                    const itemsHTML = transaction.items.map(item => `
                        <tr>
                            <td style="text-align: left; vertical-align: top; padding-right: 10px;">${item.name}</td>
                            <td style="text-align: center; vertical-align: top;">${item.quantity}</td>
                            <td style="text-align: right; vertical-align: top;">${app.util.formatCurrency(item.price)}</td>
                            <td style="text-align: right; vertical-align: top;">${app.util.formatCurrency(item.price * item.quantity)}</td>
                        </tr>`).join('');
                    const paymentDetailHTML = transaction.payment_method === 'Tunai' ? `
                        <tr><td style="text-align: right;">Tunai:</td><td style="text-align: right;">${app.util.formatCurrency(transaction.cash_received)}</td></tr>
                        <tr><td style="text-align: right;">Kembalian:</td><td style="text-align: right;">${app.util.formatCurrency(transaction.change)}</td></tr>` : '';
                    return `
                        <div style="width: 300px; font-family: 'Courier New', monospace; font-size: 12px; color: black; padding: 20px;">
                            <div style="text-align: center; margin-bottom: 10px;">
                                <img src="${settings.store_logo_url}" alt="logo" style="width: 50px; margin: 0 auto; border-radius: 50%;">
                                <h2 style="font-size: 1.2em; margin: 5px 0 0 0; font-weight: bold;">${settings.store_name}</h2>
                                <p style="margin: 2px 0; font-size: 11px;">${settings.store_address}</p>
                                <p style="margin: 2px 0; font-size: 11px;">${settings.store_phone}</p>
                            </div>
                            <hr style="border-top: 1px dashed black; margin: 10px 0;">
                            <table style="width: 100%; font-size: 11px;">
                                <tr>
                                    <td style="text-align: left;">No: ${transaction.id ? String(transaction.id).substring(0,8) : transaction.local_id.substring(0,8)}</td>
                                    <td style="text-align: right;">${new Date(transaction.created_at).toLocaleString('id-ID')}</td>
                                </tr>
                                <tr><td style="text-align: left;">Kasir: Admin</td><td></td></tr>
                            </table>
                            <hr style="border-top: 1px dashed black; margin: 10px 0;">
                            <table style="width: 100%;">
                                <thead><tr><th style="text-align: left;">Item</th><th style="text-align: center;">Qty</th><th style="text-align: right;">Harga</th><th style="text-align: right;">Total</th></tr></thead>
                                <tbody>${itemsHTML}</tbody>
                            </table>
                            <hr style="border-top: 1px dashed black; margin: 10px 0;">
                            <table style="width: 100%;">
                                <tr><td style="text-align: right;">Subtotal:</td><td style="text-align: right;">${app.util.formatCurrency(transaction.subtotal)}</td></tr>
                                <tr><td style="text-align: right;">Diskon:</td><td style="text-align: right;">${app.util.formatCurrency(transaction.discount)}</td></tr>
                                <tr style="font-weight: bold;"><td style="text-align: right;">TOTAL:</td><td style="text-align: right;">${app.util.formatCurrency(transaction.total_amount)}</td></tr>
                            </table>
                            <hr style="border-top: 1px dashed black; margin: 10px 0;">
                            <table style="width: 100%;">
                                <tr><td style="text-align: right;">Metode Bayar:</td><td style="text-align: right;">${transaction.payment_method}</td></tr>
                                ${paymentDetailHTML}
                            </table>
                            <div style="text-align: center; margin-top: 15px; font-size: 11px;"><p>${settings.receipt_footer}</p></div>
                        </div>`;
                },
                printReceipt() {
                    if (!app.state.lastTransaction) {
                        app.toast.show('Tidak ada data transaksi untuk dicetak.', 'error');
                        return;
                    }
                    const receiptHTML = this.generateReceiptHTML(app.state.lastTransaction);
                    const iframe = document.createElement('iframe');
                    iframe.style.position = 'absolute';
                    iframe.style.width = '0';
                    iframe.style.height = '0';
                    iframe.style.border = '0';
                    document.body.appendChild(iframe);
                    const doc = iframe.contentWindow.document;
                    doc.open();
                    doc.write(`<html><head><title>Cetak Struk</title></head><body>${receiptHTML}</body></html>`);
                    doc.close();
                    iframe.onload = function() {
                        try {
                            iframe.contentWindow.focus();
                            iframe.contentWindow.print();
                        } catch (e) {
                            app.toast.show('Gagal membuka dialog cetak.', 'error');
                            app.debug.log(`Print error: ${e.message}`);
                        }
                        setTimeout(() => {
                            document.body.removeChild(iframe);
                        }, 1000);
                    };
                },
                renderStockManagementPage() {
                    const productOptions = app.state.products
                        .sort((a, b) => a.name.localeCompare(b.name))
                        .map(p => `<option value="${p.id}">${p.name} (Stok: ${p.stock})</option>`).join('');
                    
                    document.getElementById('stock-in-product').innerHTML = productOptions;
                    document.getElementById('adjustment-product').innerHTML = productOptions;
                },
                renderStockHistoryModalContent(history) {
                    const contentEl = document.getElementById('stock-history-content');
                    if (!contentEl) return;

                    if (history.length === 0) {
                        contentEl.innerHTML = '<p class="text-center text-gray-500">Tidak ada riwayat untuk produk ini.</p>';
                        return;
                    }

                    const historyHtml = history.map(item => {
                        const changeClass = item.change > 0 ? 'text-green-500' : 'text-red-500';
                        const changeSign = item.change > 0 ? '+' : '';
                        return `
                            <div class="grid grid-cols-4 gap-4 py-2 border-b dark:border-gray-700">
                                <span>${new Date(item.created_at).toLocaleString('id-ID')}</span>
                                <span class="font-medium">${item.type}</span>
                                <span class="font-bold ${changeClass}">${changeSign}${item.change}</span>
                                <span>${item.notes || '-'}</span>
                            </div>
                        `;
                    }).join('');

                    contentEl.innerHTML = `
                        <div class="grid grid-cols-4 gap-4 font-bold pb-2 border-b-2 dark:border-gray-500">
                            <span>Tanggal</span>
                            <span>Tipe</span>
                            <span>Perubahan</span>
                            <span>Catatan</span>
                        </div>
                        ${historyHtml}
                    `;
                },
                renderKasirCategoryFilter() {
                    const filterEl = document.getElementById('kasir-category-filter');
                    if (!filterEl) return;
                    const categories = [...new Set(app.state.products.map(p => p.category).filter(Boolean))];
                    filterEl.innerHTML = '<option value="all">Semua Kategori</option>';
                    filterEl.innerHTML += categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                    filterEl.value = app.state.kasir.categoryFilter;
                }
            },

            router: {
                init() {
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.navigateTo(item.dataset.page);
                        });
                    });
                },
                navigateTo(pageId) {
                    app.state.currentPage = pageId;
                    document.querySelectorAll('.nav-item').forEach(item => {
                         item.firstElementChild.classList.toggle('bg-indigo-100', item.dataset.page === pageId);
                         item.firstElementChild.classList.toggle('dark:bg-gray-700', item.dataset.page === pageId);
                    });
                    app.ui.renderPage(pageId);
                    app.debug.log(`Navigasi ke halaman: ${pageId}`);
                }
            },

            events: {
                init() {
                    window.addEventListener('online', () => { app.state.online = true; app.ui.updateOnlineStatus(); app.debug.log('Status: Online'); app.sync.start(); });
                    window.addEventListener('offline', () => { app.state.online = false; app.ui.updateOnlineStatus(); app.debug.log('Status: Offline'); });
                    document.getElementById('theme-toggle').addEventListener('click', () => app.ui.toggleTheme());
                    document.getElementById('clear-debug-btn').addEventListener('click', (e) => { e.stopPropagation(); app.debug.clear(); });

                    document.body.addEventListener('click', (e) => {
                        const target = e.target;
                        const closest = (selector) => target.closest(selector);
                        if (closest('#start-camera-scan-btn')) return app.barcode.startCameraScanner('kasir');
                        if (closest('#scan-sku-btn')) return app.barcode.startCameraScanner('addProduct');
                        if (closest('#stop-camera-scan-btn')) return app.barcode.stopCameraScanner();
                        if (closest('.product-card')) return app.kasir.addToCart(closest('.product-card').dataset.id);
                        if (closest('.update-qty-btn')) return app.kasir.updateCartItemQuantity(closest('.update-qty-btn').dataset.id, parseInt(closest('.update-qty-btn').dataset.change));
                        if (closest('.remove-from-cart-btn')) return app.kasir.removeFromCart(closest('.remove-from-cart-btn').dataset.id);
                        if (closest('#pay-btn')) return app.ui.renderModal('payment-modal-template');
                        if (closest('.tab-btn')) return app.ui.renderKasirTab(closest('.tab-btn').dataset.tab);
                        if (closest('.close-modal-btn')) return app.ui.closeModal();
                        if (closest('#close-receipt-overlay-btn')) return app.ui.closeModal();
                        if (closest('#confirm-payment-btn')) return app.kasir.processPayment();
                        if (closest('#print-receipt-btn')) return app.ui.printReceipt();
                        if (closest('#add-product-btn')) return app.ui.renderModal('add-product-modal-template');
                        if (closest('#save-settings-btn')) return app.data.saveSettings();
                        if (closest('.date-filter-btn')) return app.reports.handleFilterClick(closest('.date-filter-btn'));
                        if (closest('.ppob-product-card')) return app.kasir.addPpobToCart(closest('.ppob-product-card').dataset.sku);
                        if (closest('.edit-product-btn')) return app.data.showEditProductModal(closest('.edit-product-btn').dataset.id);
                        if (closest('.delete-product-btn')) return app.data.confirmDeleteProduct(closest('.delete-product-btn').dataset.id);
                        if (closest('#discount-btn')) return app.ui.renderModal('discount-modal-template');
                        if (closest('#apply-discount-btn')) return app.kasir.applyDiscount();
                        if (closest('#import-csv-btn')) return app.data.handleImportCSV();
                        if (closest('#prev-page-btn')) { app.state.productManagement.pagination.currentPage--; app.ui.renderProductManagementPage(); }
                        if (closest('#next-page-btn')) { app.state.productManagement.pagination.currentPage++; app.ui.renderProductManagementPage(); }
                        if (closest('.sortable-header')) { app.data.sortProducts(closest('.sortable-header').dataset.sort); }
                        if (closest('#bulk-delete-btn')) { app.data.confirmBulkDelete(); }
                        if (closest('#apply-date-range-btn')) { app.reports.handleCustomDateFilter(); }
                        if (closest('#export-report-btn')) { app.reports.exportReportAsPDF(); }
                        if (closest('.transaction-row')) { app.reports.showTransactionDetailModal(closest('.transaction-row').dataset.transactionId); }
                        if (closest('.stock-history-btn')) { app.data.showStockHistory(closest('.stock-history-btn').dataset.id); }
                        if (closest('#clear-cart-btn')) { app.kasir.clearCart(); }
                        if (closest('#hold-cart-btn')) { app.kasir.holdCart(); }
                        if (closest('#resume-cart-btn')) { app.kasir.resumeCart(); }
                        if (closest('#custom-sale-btn')) { app.kasir.showCustomSaleModal(); }
                    });
                    
                    document.body.addEventListener('submit', (e) => {
                        if (e.target.id === 'add-product-form') { e.preventDefault(); app.data.addProduct(); }
                        if (e.target.id === 'edit-product-form') { e.preventDefault(); app.data.updateProduct(); }
                        if (e.target.id === 'stock-in-form') { e.preventDefault(); app.data.stockIn(); }
                        if (e.target.id === 'stock-adjustment-form') { e.preventDefault(); app.data.stockAdjustment(); }
                        if (e.target.id === 'custom-sale-form') { e.preventDefault(); app.kasir.addCustomSale(); }
                    });

                    document.body.addEventListener('input', (e) => {
                         if (e.target.id === 'cash-received') app.kasir.validatePayment();
                         if (e.target.id === 'product-search') app.ui.renderProductGrid();
                         if (e.target.id === 'store-logo-input') {
                            const file = e.target.files[0];
                            if(file) document.getElementById('store-logo-preview').src = URL.createObjectURL(file);
                         }
                         if (e.target.id === 'product-manage-search') {
                            app.state.productManagement.filters.search = e.target.value;
                            app.state.productManagement.pagination.currentPage = 1;
                            app.ui.renderProductManagementPage();
                         }
                         if (e.target.classList.contains('cart-item-qty-input')) {
                             app.kasir.updateCartItemQuantity(e.target.dataset.id, 0, e.target.value);
                         }
                    });
                    
                     document.body.addEventListener('change', (e) => {
                         if (e.target.id === 'payment-method') {
                            document.getElementById('cash-payment-fields').style.display = e.target.value === 'Tunai' ? 'block' : 'none';
                            app.kasir.validatePayment();
                         }
                         if (e.target.id === 'ppob-category-select') app.kasir.renderPpobProducts(e.target.value);
                         if (e.target.id === 'tax-enabled') document.getElementById('tax-details').style.display = e.target.checked ? 'block' : 'none';
                         if (e.target.id === 'product-category-filter') {
                            app.state.productManagement.filters.category = e.target.value;
                            app.state.productManagement.pagination.currentPage = 1;
                            app.ui.renderProductManagementPage();
                         }
                         if (e.target.id === 'kasir-category-filter') {
                            app.state.kasir.categoryFilter = e.target.value;
                            app.ui.renderProductGrid();
                         }
                         if (e.target.id === 'select-all-products-checkbox') {
                            app.data.toggleSelectAllProducts(e.target.checked);
                         }
                         if (e.target.classList.contains('product-checkbox')) {
                            app.data.toggleProductSelection(parseInt(e.target.dataset.id), e.target.checked);
                         }
                     });
                }
            },
            
            kasir: {
                addToCart(productId) {
                    const product = app.state.products.find(p => p.id == productId);
                    if (!product) return app.toast.show('Produk tidak ditemukan.', 'error');
                    if (product.stock <= 0) return app.toast.show(`Stok ${product.name} habis.`, 'error');
                    const existingItem = app.state.cart.find(item => item.id == productId);
                    if (existingItem) {
                        if (existingItem.quantity < product.stock) existingItem.quantity++;
                        else app.toast.show(`Kuantitas melebihi stok.`, 'error');
                    } else {
                        app.state.cart.push({ ...product, quantity: 1, type: 'fisik' });
                    }
                    app.ui.updateCart();
                },
                updateCartItemQuantity(itemId, change, absoluteValue = null) {
                    const item = app.state.cart.find(i => (i.id || i.buyer_sku_code) == itemId);
                    if (!item || item.type === 'ppob') return;
                    const product = app.state.products.find(p => p.id == itemId);
                    let newQuantity;

                    if (absoluteValue !== null) {
                        newQuantity = parseInt(absoluteValue);
                    } else {
                        newQuantity = item.quantity + change;
                    }

                    if (isNaN(newQuantity) || newQuantity < 0) {
                        newQuantity = 0;
                    }

                    if (newQuantity === 0) {
                        this.removeFromCart(itemId);
                    } else if (product && newQuantity > product.stock) {
                        app.toast.show(`Kuantitas melebihi stok.`, 'error');
                        item.quantity = product.stock; // Set to max stock
                    } else {
                        item.quantity = newQuantity;
                    }
                    app.ui.updateCart();
                },
                removeFromCart(itemId) {
                    app.state.cart = app.state.cart.filter(item => (item.id || item.buyer_sku_code) != itemId);
                    if(app.state.cart.length === 0) app.state.cartDiscount = 0;
                    app.ui.updateCart();
                },
                clearCart() {
                    if (app.state.cart.length === 0) return;
                    app.ui.renderModal('confirm-modal-template', {
                        title: 'Kosongkan Keranjang',
                        message: 'Apakah Anda yakin ingin menghapus semua item dari keranjang?',
                        onConfirm: () => {
                            app.state.cart = [];
                            app.state.cartDiscount = 0;
                            app.ui.updateCart();
                            app.toast.show('Keranjang dikosongkan.', 'success');
                        }
                    });
                },
                applyDiscount() {
                    const amount = parseFloat(document.getElementById('discount-amount').value) || 0;
                    app.state.cartDiscount = amount;
                    app.ui.updateCart();
                    app.ui.closeModal();
                    app.toast.show('Diskon berhasil diterapkan.', 'success');
                },
                validatePayment() {
                    const confirmBtn = document.getElementById('confirm-payment-btn');
                    if(!confirmBtn) return;
                    const paymentMethod = document.getElementById('payment-method').value;
                    const subtotal = app.state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const total = subtotal - app.state.cartDiscount;
                    if (paymentMethod === 'Tunai') {
                        const receivedEl = document.getElementById('cash-received');
                        const received = parseFloat(receivedEl.value) || 0;
                        const change = received - total;
                        document.getElementById('cash-change').textContent = app.util.formatCurrency(Math.max(0, change));
                        confirmBtn.disabled = received < total;
                    } else {
                        confirmBtn.disabled = false;
                    }
                },
                async processPayment() {
                    const subtotal = app.state.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const discount = app.state.cartDiscount;
                    const total = subtotal - discount;
                    const paymentMethod = document.getElementById('payment-method').value;
                    const cashReceivedEl = document.getElementById('cash-received');
                    const cashReceived = cashReceivedEl ? parseFloat(cashReceivedEl.value) || 0 : 0;
                    if (paymentMethod === 'Tunai' && cashReceived < total) return app.toast.show('Uang tunai kurang.', 'error');
                    
                    const transaction = {
                        local_id: self.crypto.randomUUID(), created_at: new Date().toISOString(),
                        items: app.state.cart, subtotal: subtotal, discount: discount, total_amount: total,
                        payment_method: paymentMethod, cash_received: paymentMethod === 'Tunai' ? cashReceived : null,
                        change: paymentMethod === 'Tunai' ? cashReceived - total : null, synced: false
                    };
                    
                    app.state.lastTransaction = transaction;
                    app.state.transactions.push(transaction);
                    await app.data.saveTransactions();
                    
                    const stockHistory = [];
                    for (const item of transaction.items.filter(i => i.type === 'fisik')) {
                        const product = app.state.products.find(p => p.id === item.id);
                        if(product) {
                            product.stock -= item.quantity;
                            stockHistory.push({
                                product_id: product.id,
                                change: -item.quantity,
                                stock_after: product.stock,
                                type: 'sale',
                                notes: `Transaksi #${transaction.local_id.substring(0,8)}`
                            });
                        }
                    }
                    await app.data.saveProducts();
                    await app.data.addStockHistory(stockHistory);

                    app.state.cart = [];
                    app.state.cartDiscount = 0;
                    app.ui.updateCart();
                    app.ui.closeModal();
                    app.ui.showReceiptOverlay(transaction);
                    app.ui.renderProductGrid();
                    app.debug.log(`Transaksi ${transaction.local_id.substring(0,8)} dibuat.`);
                    if (app.state.online) app.sync.start();
                },
                showCustomSaleModal() {
                    app.ui.renderModal('custom-sale-modal-template');
                },
                addCustomSale() {
                    const name = document.getElementById('custom-sale-name').value;
                    const price = parseFloat(document.getElementById('custom-sale-price').value);

                    if (!name || !price || price <= 0) {
                        app.toast.show('Nama dan harga item harus diisi.', 'error');
                        return;
                    }

                    const customItem = {
                        id: `custom-${Date.now()}`,
                        name: name,
                        price: price,
                        quantity: 1,
                        type: 'custom'
                    };

                    app.state.cart.push(customItem);
                    app.ui.updateCart();
                    app.ui.closeModal();
                    app.toast.show(`"${name}" ditambahkan ke keranjang.`, 'success');
                },
                holdCart() {
                    if (app.state.cart.length === 0) return;
                    app.state.heldCarts.push({
                        id: Date.now(),
                        name: `Transaksi Ditahan - ${new Date().toLocaleTimeString('id-ID')}`,
                        items: [...app.state.cart],
                        discount: app.state.cartDiscount
                    });
                    app.state.cart = [];
                    app.state.cartDiscount = 0;
                    app.ui.updateCart();
                    app.toast.show('Transaksi berhasil ditahan.', 'success');
                },
                resumeCart() {
                    if (app.state.heldCarts.length === 0) {
                        app.toast.show('Tidak ada transaksi yang ditahan.', 'info');
                        return;
                    }
                    app.ui.renderModal('held-carts-modal-template');
                },
                renderHeldCarts() {
                    const container = document.getElementById('held-carts-list');
                    if (!container) return;
                    if (app.state.heldCarts.length === 0) {
                        container.innerHTML = '<p class="text-center text-gray-500">Tidak ada transaksi yang ditahan.</p>';
                        return;
                    }
                    container.innerHTML = app.state.heldCarts.map((cart, index) => `
                        <div class="p-4 border rounded-lg flex justify-between items-center hover:bg-gray-100 dark:hover:bg-gray-700">
                            <div>
                                <p class="font-semibold">${cart.name}</p>
                                <p class="text-sm text-gray-500">${cart.items.length} item - Total: ${app.util.formatCurrency(cart.items.reduce((sum, i) => sum + i.price * i.quantity, 0) - cart.discount)}</p>
                            </div>
                            <button class="resume-cart-action-btn bg-green-500 text-white py-1 px-3 rounded" data-index="${index}">Lanjutkan</button>
                        </div>
                    `).join('');

                    document.querySelectorAll('.resume-cart-action-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const index = parseInt(e.target.dataset.index);
                            this.loadHeldCart(index);
                        });
                    });
                },
                loadHeldCart(index) {
                    if (app.state.cart.length > 0) {
                        app.toast.show('Keranjang saat ini tidak kosong. Tahan atau selesaikan dulu.', 'error');
                        return;
                    }
                    const heldCart = app.state.heldCarts[index];
                    app.state.cart = heldCart.items;
                    app.state.cartDiscount = heldCart.discount;
                    app.state.heldCarts.splice(index, 1);
                    app.ui.updateCart();
                    app.ui.closeModal();
                    app.toast.show('Transaksi berhasil dilanjutkan.', 'success');
                }
            },
            
            data: {
                async loadSettings() {
                    try {
                        let settingsData = null;
                        if (app.state.online) {
                            app.debug.log('Memuat pengaturan dari Supabase...');
                            const { data, error } = await db.from('store_settings').select('*').eq('id', 1).single();
                            if (error && error.code !== 'PGRST116') {
                                throw new Error(`Supabase error: ${error.message}`);
                            }
                            if (data) {
                                settingsData = data;
                                await localforage.setItem('pos_settings', settingsData);
                                app.debug.log('Pengaturan dari Supabase berhasil dimuat dan disimpan lokal.');
                            }
                        }
                        if (!settingsData) {
                            app.debug.log('Gagal memuat dari Supabase atau sedang offline, mencoba dari lokal...');
                            settingsData = await localforage.getItem('pos_settings');
                            if(settingsData) app.debug.log('Pengaturan berhasil dimuat dari lokal.');
                        }
                        if (settingsData) {
                            app.state.settings = settingsData;
                        } else {
                            app.debug.log('Tidak ada pengaturan ditemukan di lokal maupun Supabase.');
                        }
                    } catch (error) {
                        app.debug.log(`Gagal memuat pengaturan: ${error.message}`);
                        app.toast.show('Gagal memuat pengaturan toko.', 'error');
                    }
                },
                async saveSettings() {
                    const saveBtn = document.getElementById('save-settings-btn');
                    if (!saveBtn) return;

                    const saveBtnSpan = saveBtn.querySelector('span');
                    saveBtn.disabled = true;
                    saveBtnSpan.textContent = 'Menyimpan...';

                    if (!app.state.online) {
                        app.toast.show('Anda harus online untuk menyimpan pengaturan.', 'error');
                        saveBtn.disabled = false;
                        saveBtnSpan.textContent = 'Simpan Pengaturan';
                        return;
                    }

                    const settingsUpdatePayload = {};
                    const addFieldToPayload = (id, payloadKey, property = 'value') => {
                        const el = document.getElementById(id);
                        if (el) settingsUpdatePayload[payloadKey] = el[property];
                    };
                    
                    addFieldToPayload('store-name', 'store_name');
                    addFieldToPayload('store-address', 'store_address');
                    addFieldToPayload('store-phone', 'store_phone');
                    addFieldToPayload('store-npwp', 'store_npwp');
                    addFieldToPayload('app-font', 'app_font');
                    addFieldToPayload('receipt-paper-size', 'receipt_paper_size');
                    addFieldToPayload('receipt-footer', 'receipt_footer');
                    addFieldToPayload('tax-enabled', 'tax_enabled', 'checked');

                    const taxPercentEl = document.getElementById('tax-percent');
                    if (taxPercentEl) settingsUpdatePayload.tax_percent = parseFloat(taxPercentEl.value) || 0;

                    const logoFile = document.getElementById('store-logo-input')?.files[0];
                    if (logoFile) {
                        app.debug.log('Mengunggah logo baru...');
                        const filePath = `public/logo-${Date.now()}.${logoFile.name.split('.').pop()}`;
                        const { error: uploadError } = await db.storage.from('store_assets').upload(filePath, logoFile);
                        if (uploadError) {
                            app.toast.show('Gagal mengunggah logo.', 'error');
                            app.debug.log(`Upload error: ${uploadError.message}`);
                        } else {
                            const { data: urlData } = db.storage.from('store_assets').getPublicUrl(filePath);
                            settingsUpdatePayload.store_logo_url = urlData.publicUrl;
                            app.debug.log(`Logo berhasil diunggah: ${settingsUpdatePayload.store_logo_url}`);
                        }
                    }

                    if (Object.keys(settingsUpdatePayload).length === 0 && !logoFile) {
                        app.toast.show('Tidak ada perubahan untuk disimpan.', 'info');
                    } else {
                        const { data, error } = await db.from('store_settings').update(settingsUpdatePayload).eq('id', 1).select().single();
                        if (error) {
                            app.debug.log(`Error menyimpan pengaturan: ${error.message}`);
                            app.toast.show('Gagal menyimpan pengaturan.', 'error');
                        } else if(data) {
                            app.state.settings = data;
                            await localforage.setItem('pos_settings', data);
                            app.ui.updateStoreInfo();
                            app.ui.initTheme();
                            app.toast.show('Pengaturan berhasil disimpan ke database.', 'success');
                        }
                    }
                    
                    saveBtn.disabled = false;
                    saveBtnSpan.textContent = 'Simpan Pengaturan';
                },
                async loadProducts() {
                    const localProducts = await localforage.getItem('pos_products');
                    if (localProducts) {
                        app.state.products = localProducts;
                        app.debug.log(`${localProducts.length} produk dimuat dari lokal.`);
                    }
                    if (app.state.online) {
                        app.debug.log('Mengambil produk dari Supabase...');
                        const { data, error } = await db.from('products').select('*');
                        if (error) app.debug.log(`Error Supabase: ${error.message}`);
                        else if (data) {
                            app.state.products = data;
                            await this.saveProducts();
                            app.debug.log(`${data.length} produk disinkronkan dari Supabase.`);
                        }
                    }
                },
                async saveProducts() {
                    await localforage.setItem('pos_products', app.state.products);
                },
                async addProduct() {
                    const saveBtn = document.getElementById('save-product-btn');
                    saveBtn.disabled = true; saveBtn.textContent = 'Menyimpan...';
                    if (!app.state.online) {
                        app.toast.show('Anda harus online untuk menambah produk.', 'error');
                        saveBtn.disabled = false; saveBtn.textContent = 'Simpan';
                        return;
                    }
                    const newProductData = {
                        name: document.getElementById('product-name').value,
                        price: parseFloat(document.getElementById('product-price').value),
                        cost_price: parseFloat(document.getElementById('product-cost-price').value) || null,
                        stock: parseInt(document.getElementById('product-stock').value),
                        sku: document.getElementById('product-sku').value || null,
                        category: document.getElementById('product-category').value || null,
                        image_url: document.getElementById('product-image-url').value || null,
                    };
                    const { data: newProduct, error } = await db.from('products').insert(newProductData).select().single();
                    saveBtn.disabled = false; saveBtn.textContent = 'Simpan';

                    if (error) {
                        app.debug.log(`Error tambah produk: ${error.message}`);
                        app.toast.show(`Gagal menyimpan produk.`, 'error');
                        return;
                    }

                    if(newProduct) {
                        await this.addStockHistory([{
                            product_id: newProduct.id,
                            change: newProduct.stock,
                            stock_after: newProduct.stock,
                            type: 'initial',
                            notes: 'Stok awal'
                        }]);

                        app.state.products.push(newProduct);
                        await this.saveProducts();
                        app.toast.show(`Produk '${newProduct.name}' berhasil ditambahkan.`, 'success');
                        app.ui.renderProductManagementPage();
                        app.ui.closeModal();
                    }
                },
                showEditProductModal(productId) {
                    const product = app.state.products.find(p => p.id == productId);
                    if (product) app.ui.renderModal('edit-product-modal-template', { product });
                },
                async updateProduct() {
                    const updateBtn = document.getElementById('update-product-btn');
                    updateBtn.disabled = true; updateBtn.textContent = 'Menyimpan...';
                    if (!app.state.online) {
                        app.toast.show('Anda harus online untuk mengubah produk.', 'error');
                        updateBtn.disabled = false; updateBtn.textContent = 'Simpan Perubahan';
                        return;
                    }
                    const productId = document.getElementById('edit-product-id').value;
                    const updatedProductData = {
                        name: document.getElementById('edit-product-name').value,
                        price: parseFloat(document.getElementById('edit-product-price').value),
                        cost_price: parseFloat(document.getElementById('edit-product-cost-price').value) || null,
                        stock: parseInt(document.getElementById('edit-product-stock').value),
                        sku: document.getElementById('edit-product-sku').value || null,
                        category: document.getElementById('edit-product-category').value || null,
                        image_url: document.getElementById('edit-product-image-url').value || null,
                    };
                    const { data, error } = await db.from('products').update(updatedProductData).eq('id', productId).select().single();
                    updateBtn.disabled = false; updateBtn.textContent = 'Simpan Perubahan';
                    if (error) {
                        app.debug.log(`Error update produk: ${error.message}`);
                        app.toast.show('Gagal menyimpan perubahan.', 'error');
                        return;
                    }
                    if (data) {
                        const index = app.state.products.findIndex(p => p.id == productId);
                        if (index !== -1) app.state.products[index] = data;
                        await this.saveProducts();
                        app.toast.show('Produk berhasil diperbarui.', 'success');
                        app.ui.renderProductManagementPage();
                        app.ui.closeModal();
                    }
                },
                confirmDeleteProduct(productId) {
                    app.ui.renderModal('confirm-modal-template', {
                        title: 'Hapus Produk',
                        message: 'Apakah Anda yakin ingin menghapus produk ini? Semua riwayat stok terkait juga akan terhapus.',
                        onConfirm: () => this.deleteProduct(productId)
                    });
                },
                async deleteProduct(productId) {
                     if (!app.state.online) {
                        app.toast.show('Anda harus online untuk menghapus produk.', 'error');
                        return;
                    }
                    const { error } = await db.from('products').delete().eq('id', productId);
                    if (error) {
                        app.debug.log(`Error hapus produk: ${error.message}`);
                        app.toast.show('Gagal menghapus produk.', 'error');
                        return;
                    }
                    app.state.products = app.state.products.filter(p => p.id != productId);
                    await this.saveProducts();
                    app.toast.show('Produk berhasil dihapus.', 'success');
                    app.ui.renderProductManagementPage();
                },
                 async loadTransactions() {
                    const localTransactions = await localforage.getItem('pos_transactions') || [];
                    app.state.transactions = localTransactions.filter(t => t.local_id); 
                    app.debug.log(`${localTransactions.length} transaksi valid dimuat dari lokal.`);
                    if (app.state.online) {
                        app.debug.log('Mengambil riwayat transaksi dari Supabase...');
                        const { data: cloudTransactions, error } = await db.from('transactions').select('*, sale_items(*, products(name, sku, cost_price))').order('created_at', { ascending: false });
                        if (error) {
                            app.debug.log(`Error mengambil transaksi cloud: ${error.message}`);
                            return;
                        }
                        const transactionMap = new Map();
                        app.state.transactions.forEach(tx => transactionMap.set(tx.local_id, tx));
                        cloudTransactions.forEach(cloudTx => {
                            const formattedTx = {
                                id: cloudTx.id, local_id: cloudTx.id, created_at: cloudTx.created_at,
                                items: cloudTx.sale_items.map(item => ({ ...(item.products || {}), ...item })),
                                subtotal: cloudTx.subtotal, discount: cloudTx.discount, total_amount: cloudTx.total_amount,
                                payment_method: cloudTx.payment_method, cash_received: cloudTx.cash_received, change: cloudTx.change,
                                synced: true,
                            };
                            transactionMap.set(formattedTx.id, formattedTx);
                        });
                        app.state.transactions = Array.from(transactionMap.values());
                        await this.saveTransactions();
                        app.debug.log(`Total transaksi setelah sinkronisasi: ${app.state.transactions.length}`);
                    }
                },
                async saveTransactions() {
                    await localforage.setItem('pos_transactions', app.state.transactions);
                },
                handleImportCSV() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.csv';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        app.toast.show('Memproses file CSV...', 'info');
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const csv = event.target.result;
                                const lines = csv.split(/\r\n|\n/);
                                const headers = lines[0].split(',').map(h => h.trim());
                                const productsToUpsert = [];
                                for (let i = 1; i < lines.length; i++) {
                                    if (!lines[i]) continue;
                                    const values = lines[i].split(',');
                                    const product = {};
                                    headers.forEach((header, index) => {
                                        const value = values[index] ? values[index].trim() : null;
                                        if (value !== null) {
                                            if (['price', 'cost_price', 'stock'].includes(header)) {
                                                product[header] = parseFloat(value) || 0;
                                            } else {
                                                product[header] = value;
                                            }
                                        }
                                    });
                                    if (product.name) productsToUpsert.push(product);
                                }
                                if (productsToUpsert.length > 0) {
                                    app.debug.log(`Mencoba mengunggah ${productsToUpsert.length} produk...`);
                                    const { error } = await db.from('products').upsert(productsToUpsert, { onConflict: 'sku' });
                                    if (error) throw new Error(error.message);
                                    app.toast.show(`${productsToUpsert.length} produk berhasil diimpor/diperbarui.`, 'success');
                                    await this.loadProducts();
                                    app.ui.renderProductManagementPage();
                                } else {
                                    app.toast.show('Tidak ada produk valid yang ditemukan di file CSV.', 'error');
                                }
                            } catch (err) {
                                app.toast.show('Gagal memproses file CSV. Pastikan formatnya benar.', 'error');
                                app.debug.log(`Error impor CSV: ${err.message}`);
                            }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                },
                sortProducts(column) {
                    const { sorting } = app.state.productManagement;
                    if (sorting.column === column) {
                        sorting.direction = sorting.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sorting.column = column;
                        sorting.direction = 'asc';
                    }
                    app.ui.renderProductManagementPage();
                },
                toggleProductSelection(productId, isSelected) {
                    const { selectedProducts } = app.state.productManagement;
                    if (isSelected) {
                        if (!selectedProducts.includes(productId)) selectedProducts.push(productId);
                    } else {
                        const index = selectedProducts.indexOf(productId);
                        if (index > -1) selectedProducts.splice(index, 1);
                    }
                    app.ui.updateBulkActionUI();
                },
                toggleSelectAllProducts(isChecked) {
                    const checkboxes = document.querySelectorAll('.product-checkbox');
                    const selectedIds = [];
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = isChecked;
                        if (isChecked) {
                            selectedIds.push(parseInt(checkbox.dataset.id));
                        }
                    });
                    app.state.productManagement.selectedProducts = selectedIds;
                    app.ui.updateBulkActionUI();
                },
                confirmBulkDelete() {
                    const selectedCount = app.state.productManagement.selectedProducts.length;
                    app.ui.renderModal('confirm-modal-template', {
                        title: 'Hapus Produk Massal',
                        message: `Apakah Anda yakin ingin menghapus ${selectedCount} produk yang dipilih?`,
                        onConfirm: () => this.bulkDeleteProducts()
                    });
                },
                async bulkDeleteProducts() {
                    const idsToDelete = app.state.productManagement.selectedProducts;
                    if (idsToDelete.length === 0) return;

                    app.toast.show(`Menghapus ${idsToDelete.length} produk...`, 'info');
                    const { error } = await db.from('products').delete().in('id', idsToDelete);

                    if (error) {
                        app.toast.show('Gagal menghapus produk.', 'error');
                        app.debug.log(`Bulk delete error: ${error.message}`);
                        return;
                    }

                    app.state.products = app.state.products.filter(p => !idsToDelete.includes(p.id));
                    app.state.productManagement.selectedProducts = [];
                    await this.saveProducts();
                    app.toast.show('Produk terpilih berhasil dihapus.', 'success');
                    app.ui.renderProductManagementPage();
                },
                async addStockHistory(historyEntries) {
                    if (!app.state.online) {
                        app.debug.log('Offline, riwayat stok akan disinkronkan nanti.');
                        return;
                    }
                    const { error } = await db.from('stock_history').insert(historyEntries);
                    if (error) {
                        app.debug.log(`Gagal menyimpan riwayat stok: ${error.message}`);
                    }
                },
                async stockIn() {
                    const form = document.getElementById('stock-in-form');
                    const productId = parseInt(form.querySelector('#stock-in-product').value);
                    const quantity = parseInt(form.querySelector('#stock-in-quantity').value);
                    const notes = form.querySelector('#stock-in-notes').value;

                    const product = app.state.products.find(p => p.id === productId);
                    if (!product || !quantity) {
                        app.toast.show('Data tidak lengkap.', 'error');
                        return;
                    }
                    
                    const newStock = product.stock + quantity;
                    const { error } = await db.from('products').update({ stock: newStock }).eq('id', productId);
                    if (error) {
                        app.toast.show('Gagal memperbarui stok produk.', 'error');
                        return;
                    }

                    await this.addStockHistory([{
                        product_id: productId,
                        change: quantity,
                        stock_after: newStock,
                        type: 'stock_in',
                        notes: notes
                    }]);

                    product.stock = newStock;
                    await this.saveProducts();
                    app.toast.show('Stok berhasil ditambahkan.', 'success');
                    form.reset();
                    app.ui.renderStockManagementPage();
                },
                async stockAdjustment() {
                    const form = document.getElementById('stock-adjustment-form');
                    const productId = parseInt(form.querySelector('#adjustment-product').value);
                    const newStock = parseInt(form.querySelector('#adjustment-quantity').value);
                    const notes = form.querySelector('#adjustment-notes').value;
                    
                    const product = app.state.products.find(p => p.id === productId);
                    if (!product || newStock < 0 || !notes) {
                        app.toast.show('Data tidak lengkap atau tidak valid.', 'error');
                        return;
                    }

                    const change = newStock - product.stock;
                    const { error } = await db.from('products').update({ stock: newStock }).eq('id', productId);
                     if (error) {
                        app.toast.show('Gagal memperbarui stok produk.', 'error');
                        return;
                    }

                    await this.addStockHistory([{
                        product_id: productId,
                        change: change,
                        stock_after: newStock,
                        type: 'adjustment',
                        notes: notes
                    }]);

                    product.stock = newStock;
                    await this.saveProducts();
                    app.toast.show('Stok berhasil disesuaikan.', 'success');
                    form.reset();
                    app.ui.renderStockManagementPage();
                },
                async showStockHistory(productId) {
                    app.toast.show('Memuat riwayat...', 'info');
                    const { data, error } = await db.from('stock_history')
                        .select('*')
                        .eq('product_id', productId)
                        .order('created_at', { ascending: false });
                    
                    if (error) {
                        app.toast.show('Gagal memuat riwayat stok.', 'error');
                        return;
                    }
                    app.ui.renderModal('stock-history-modal-template', { history: data });
                }
            },
            
            sync: {
                isSyncing: false,
                init() {
                    app.ui.updateOnlineStatus();
                    if(app.state.online) this.start();
                },
                async start() {
                    if (this.isSyncing || !app.state.online) return;
                    this.isSyncing = true;
                    app.debug.log('Memulai proses sinkronisasi...');
                    await this.syncTransactions();
                    await this.syncStockUpdates();
                    this.isSyncing = false;
                    app.debug.log('Sinkronisasi selesai.');
                },
                async syncTransactions() {
                    const unsynced = app.state.transactions.filter(t => !t.synced);
                    if (unsynced.length === 0) return;
                    app.debug.log(`Menemukan ${unsynced.length} transaksi untuk disinkronkan.`);
                    for (const localTx of unsynced) {
                        const transactionToInsert = {
                            created_at: localTx.created_at, total_amount: localTx.total_amount, payment_method: localTx.payment_method,
                            subtotal: localTx.subtotal, discount: localTx.discount, cash_received: localTx.cash_received, change: localTx.change,
                        };
                        const { data: newTxData, error: tError } = await db.from('transactions').insert(transactionToInsert).select('id').single();
                        if (tError) { app.debug.log(`Error sync tx: ${tError.message}`); continue; }
                        const newTransactionId = newTxData.id;
                        const saleItemsToSync = localTx.items.filter(item => item.type === 'fisik').map(item => ({
                            transaction_id: newTransactionId, product_id: item.id, quantity: item.quantity, price: item.price
                        }));
                        if(saleItemsToSync.length > 0) {
                            const { error: iError } = await db.from('sale_items').insert(saleItemsToSync);
                            if (iError) { app.debug.log(`Error sync item untuk tx ${newTransactionId}: ${iError.message}`); continue; }
                        }
                        const originalTx = app.state.transactions.find(t => t.local_id === localTx.local_id);
                        if (originalTx) { originalTx.synced = true; originalTx.id = newTransactionId; }
                        app.debug.log(`Transaksi ${localTx.local_id.substring(0,8)} disinkronkan -> ID: ${newTransactionId}`);
                    }
                    await app.data.saveTransactions();
                    if(app.state.currentPage === 'laporan') app.reports.init();
                },
                async syncStockUpdates() {
                    const productsToUpdate = app.state.products;
                    if(productsToUpdate.length === 0) return;
                    app.debug.log(`Menyinkronkan stok untuk ${productsToUpdate.length} produk...`);
                    const updatePromises = productsToUpdate.map(product => db.from('products').update({ stock: product.stock }).eq('id', product.id));
                    try {
                        const results = await Promise.all(updatePromises);
                        const errors = results.filter(res => res.error);
                        if (errors.length > 0) {
                            app.debug.log(`Gagal menyinkronkan stok untuk ${errors.length} produk.`);
                            errors.forEach(err => app.debug.log(`-> ${err.error.message}`));
                        } else {
                            app.debug.log('Stok produk berhasil disinkronkan.');
                        }
                    } catch(error) {
                         app.debug.log(`Gagal menyinkronkan stok: ${error.message}`);
                    }
                }
            },
            
            pwa: {
                deferredPrompt: null,
                init() {
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        this.deferredPrompt = e;
                        document.getElementById('install-pwa-btn').classList.remove('hidden');
                        app.debug.log('PWA install prompt tersedia.');
                    });
                    document.getElementById('install-pwa-btn').addEventListener('click', () => this.install());
                },
                async install() {
                    if (this.deferredPrompt) {
                        this.deferredPrompt.prompt();
                        const { outcome } = await this.deferredPrompt.userChoice;
                        app.debug.log(`PWA install outcome: ${outcome}`);
                        this.deferredPrompt = null;
                        document.getElementById('install-pwa-btn').classList.add('hidden');
                    }
                }
            },

            barcode: {
                html5QrCode: null, isScanning: false,
                initPhysicalScanner() {
                    let barcode = ""; let lastInputTime = Date.now();
                    window.addEventListener('keydown', e => {
                        if (app.state.currentPage !== 'kasir' || ['INPUT', 'TEXTAREA'].includes(e.target.tagName)) return;
                        const currentTime = Date.now();
                        if (currentTime - lastInputTime > 100) barcode = "";
                        lastInputTime = currentTime;
                        if (e.key === "Enter") {
                            if (barcode.length > 3) {
                                app.debug.log(`Pemindai fisik: ${barcode}`);
                                this.findAndAddToCart(barcode);
                            }
                            barcode = "";
                        } else if (e.key.length === 1) {
                            barcode += e.key;
                        }
                    });
                },
                startCameraScanner(context = 'kasir') {
                    if (this.isScanning) return;
                    app.state.scanContext = context;
                    const scannerOverlay = document.getElementById('barcode-scanner-overlay');
                    scannerOverlay.classList.remove('hidden'); scannerOverlay.classList.add('flex');
                    this.isScanning = true;
                    this.html5QrCode = new Html5Qrcode("barcode-reader");
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    const onScanSuccess = (decodedText, decodedResult) => {
                        if (this.isScanning) { 
                            this.isScanning = false; 
                            this.stopCameraScanner().then(() => {
                                app.debug.log(`Kamera: ${decodedText}`);
                                if (app.state.scanContext === 'addProduct') this.populateSkuField(decodedText);
                                else this.findAndAddToCart(decodedText);
                            });
                        }
                    };
                    this.html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
                    .catch(err => {
                        app.debug.log(`Gagal mulai kamera: ${err}`);
                        app.toast.show('Tidak dapat mengakses kamera.', 'error');
                        this.stopCameraScanner();
                    });
                },
                async stopCameraScanner() {
                    if (this.html5QrCode && this.html5QrCode.isScanning) {
                        try { await this.html5QrCode.stop(); app.debug.log("Kamera dihentikan."); } 
                        catch(err) { app.debug.log("Gagal henti kamera."); }
                    }
                    this.isScanning = false;
                    const scannerOverlay = document.getElementById('barcode-scanner-overlay');
                    scannerOverlay.classList.add('hidden'); scannerOverlay.classList.remove('flex');
                },
                findAndAddToCart(sku) {
                    const product = app.state.products.find(p => p.sku === sku);
                    if (product) {
                        app.kasir.addToCart(product.id);
                        app.toast.show(`Produk ditemukan: ${product.name}`, 'success');
                    } else {
                        app.toast.show(`SKU '${sku}' tidak ditemukan.`, 'error');
                        const searchInput = document.getElementById('product-search');
                        if (searchInput) { searchInput.value = sku; searchInput.focus(); }
                    }
                },
                populateSkuField(sku) {
                    const skuInput = document.getElementById('product-sku');
                    if (skuInput) skuInput.value = sku;
                    else app.debug.log('Error: SKU input field tidak ditemukan.');
                }
            },

            reports: {
                init() {
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('start-date-filter').value = today;
                    document.getElementById('end-date-filter').value = today;
                    this.updateReportView('today');
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                },
                handleFilterClick(button) {
                    document.querySelectorAll('.date-filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
                    });
                    button.classList.add('active', 'bg-indigo-600', 'text-white');
                    button.classList.remove('bg-gray-200', 'dark:bg-gray-700');
                    this.updateReportView(button.dataset.range);
                },
                handleCustomDateFilter() {
                    document.querySelectorAll('.date-filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'bg-indigo-600', 'text-white');
                        btn.classList.add('bg-gray-200', 'dark:bg-gray-700');
                    });
                    this.updateReportView('custom');
                },
                updateReportView(range) {
                    const data = this.generateReportData(range);
                    this.updateKpiCards(data);
                    this.renderSalesChart(data.salesByDay);
                    this.renderCategorySalesChart(data.salesByCategory);
                    app.ui.renderReportTable(data.transactions);
                },
                generateReportData(period) {
                    let startDate = new Date();
                    let endDate = new Date();

                    if (period === 'today') {
                        startDate.setHours(0, 0, 0, 0);
                    } else if (period === '7days') {
                        startDate.setDate(endDate.getDate() - 6);
                        startDate.setHours(0, 0, 0, 0);
                    } else if (period === '30days') {
                        startDate.setDate(endDate.getDate() - 29);
                        startDate.setHours(0, 0, 0, 0);
                    } else if (period === 'custom') {
                        startDate = new Date(document.getElementById('start-date-filter').value);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = new Date(document.getElementById('end-date-filter').value);
                        endDate.setHours(23, 59, 59, 999);
                    }

                    const filteredTransactions = app.state.transactions.filter(t => {
                        const txDate = new Date(t.created_at);
                        return txDate >= startDate && txDate <= endDate;
                    });

                    let totalRevenue = 0, totalProfit = 0, totalTransactions = filteredTransactions.length;
                    const productSales = {}, salesByCategory = {};

                    filteredTransactions.forEach(t => {
                        totalRevenue += t.total_amount;
                        if(t.items) {
                            t.items.forEach(item => {
                                const profitPerItem = (item.price - (item.cost_price || item.price)) * item.quantity;
                                totalProfit += profitPerItem;
                                productSales[item.name] = (productSales[item.name] || 0) + item.quantity;
                                if (item.category) {
                                    salesByCategory[item.category] = (salesByCategory[item.category] || 0) + (item.price * item.quantity);
                                }
                            });
                        }
                    });
                    
                    const bestSeller = Object.keys(productSales).reduce((a, b) => productSales[a] > productSales[b] ? a : b, '-');
                    const salesByDay = filteredTransactions.reduce((acc, t) => {
                        const date = new Date(t.created_at).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                        acc[date] = (acc[date] || 0) + t.total_amount;
                        return acc;
                    }, {});

                    return {
                        transactions: filteredTransactions.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)),
                        totalRevenue, totalProfit, totalTransactions, bestSeller, salesByCategory, salesByDay
                    };
                },
                updateKpiCards(data) {
                    document.getElementById('report-total-profit').textContent = app.util.formatCurrency(data.totalProfit);
                    document.getElementById('report-total-revenue').textContent = app.util.formatCurrency(data.totalRevenue);
                    document.getElementById('report-total-transactions').textContent = data.totalTransactions;
                    document.getElementById('report-best-seller').textContent = data.bestSeller;
                },
                renderSalesChart(salesData) {
                    const ctx = document.getElementById('sales-chart'); if (!ctx) return;
                    if (app.state.charts.sales) app.state.charts.sales.destroy();
                    app.state.charts.sales = new Chart(ctx, {
                        type: 'bar',
                        data: { labels: Object.keys(salesData), datasets: [{ label: 'Pendapatan', data: Object.values(salesData), backgroundColor: 'rgba(79, 70, 229, 0.8)' }] },
                        options: { scales: { y: { beginAtZero: true } } }
                    });
                },
                renderCategorySalesChart(categoryData) {
                    const ctx = document.getElementById('category-sales-chart'); if (!ctx) return;
                    if (app.state.charts.category) app.state.charts.category.destroy();
                    app.state.charts.category = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(categoryData),
                            datasets: [{ data: Object.values(categoryData), backgroundColor: ['#4f46e5', '#10b981', '#f97316', '#ef4444', '#8b5cf6'] }]
                        },
                        options: {
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                },
                showTransactionDetailModal(transactionId) {
                    const transaction = app.state.transactions.find(t => String(t.local_id || t.id) === String(transactionId));
                    if (transaction) {
                        app.ui.renderModal('transaction-detail-modal-template', { transaction });
                    }
                },
                renderTransactionDetail(transaction) {
                    const contentEl = document.getElementById('transaction-detail-content');
                    if (!contentEl) return;
                    const profit = transaction.items.reduce((sum, item) => sum + ((item.price - (item.cost_price || item.price)) * item.quantity), 0);
                    
                    const itemsHtml = transaction.items.map(item => `
                        <tr class="border-b dark:border-gray-600">
                            <td class="p-2">${item.name}</td>
                            <td class="p-2 text-center">${item.quantity}</td>
                            <td class="p-2 text-right">${app.util.formatCurrency(item.price)}</td>
                            <td class="p-2 text-right">${app.util.formatCurrency(item.price * item.quantity)}</td>
                        </tr>
                    `).join('');

                    contentEl.innerHTML = `
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 mb-4">
                            <div><strong>ID Transaksi:</strong></div><div>${String(transaction.local_id || transaction.id).substring(0,8)}</div>
                            <div><strong>Tanggal:</strong></div><div>${new Date(transaction.created_at).toLocaleString('id-ID')}</div>
                            <div><strong>Metode Bayar:</strong></div><div>${transaction.payment_method}</div>
                        </div>
                        <h4 class="font-bold mt-4 mb-2">Rincian Item:</h4>
                        <table class="w-full text-left">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr><th class="p-2">Item</th><th class="p-2 text-center">Qty</th><th class="p-2 text-right">Harga</th><th class="p-2 text-right">Subtotal</th></tr>
                            </thead>
                            <tbody>${itemsHtml}</tbody>
                        </table>
                        <div class="border-t dark:border-gray-600 mt-4 pt-4 text-right space-y-1">
                            <p>Subtotal: <strong>${app.util.formatCurrency(transaction.subtotal)}</strong></p>
                            <p>Diskon: <strong class="text-red-500">-${app.util.formatCurrency(transaction.discount)}</strong></p>
                            <p>Keuntungan: <strong class="text-green-600">${app.util.formatCurrency(profit)}</strong></p>
                            <p class="text-lg font-bold">Total: ${app.util.formatCurrency(transaction.total_amount)}</p>
                        </div>
                    `;
                },
                exportReportAsPDF() {
                    app.toast.show('Mempersiapkan laporan PDF...', 'info');
                    const { jsPDF } = window.jspdf;
                    const reportEl = document.getElementById('report-page-container');
                    
                    html2canvas(reportEl, { scale: 2 }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                        pdf.save(`laporan-penjualan-${new Date().toISOString().split('T')[0]}.pdf`);
                        app.toast.show('Laporan PDF berhasil diunduh.', 'success');
                    }).catch(err => {
                        app.toast.show('Gagal membuat PDF.', 'error');
                        app.debug.log(`PDF export error: ${err.message}`);
                    });
                }
            },

            util: {
                formatCurrency(amount) {
                    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount || 0);
                }
            }
        };

        app.init();
    </script>
</body>
</html>
